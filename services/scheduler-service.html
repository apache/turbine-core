<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.8.1 from xdocs/services\scheduler-service.xml at 18 June 2019 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Apache Turbine &#x2013; Turbine Services - Scheduler Service</title>
    <style type="text/css" media="all">
      @import url("../css/maven-base.css");
      @import url("../css/maven-theme.css");
      @import url("../css/site.css");
    </style>
    <link rel="stylesheet" href="../css/print.css" type="text/css" media="print" />
    <meta http-equiv="Content-Language" content="en" />
    
  </head>
  <body class="composite">
    <div id="banner">
<a href="../../../" id="bannerLeft" title="Apache Turbine"><img src="../images/turbine-project-apache-separate.png"  alt="Apache Turbine"/></a>
<div id="bannerRight">
<img src="../images/logo.gif"  alt=""/></div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 18 June 2019</span>
          &nbsp;| <span id="projectVersion">Version: 5.1-SNAPSHOT</span>
      </div>
      <div class="xright"><a href="http://www.apache.org" class="externalLink" title="Apache">Apache</a> |
<a href="../../../" title="Turbine">Turbine</a> |
<a href="../../../fulcrum/" title="Fulcrum">Fulcrum</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>General Information</h5>
    <ul>
     <li class="none"><a href="../index.html" title="Overview">Overview</a></li>
     <li class="none"><a href="../features.html" title="Features">Features</a></li>
     <li class="none"><a href="../fsd.html" title="Specification">Specification</a></li>
     <li class="none"><a href="../getting-started.html" title="Getting Started">Getting Started</a></li>
     <li class="none"><a href="../how-to-build.html" title="Howto Build Turbine">Howto Build Turbine</a></li>
     <li class="none"><a href="../changes-report.html" title="Changes">Changes</a></li>
    </ul>
       <h5>Documentation</h5>
    <ul>
     <li class="expanded"><a href="../services/index.html" title="Services">Services</a>
      <ul>
       <li class="none"><a href="../services/assemblerbroker-service.html" title="Assembler Broker Service">Assembler Broker Service</a></li>
       <li class="none"><a href="../services/avalon-component-service.html" title="Avalon Component Service">Avalon Component Service</a></li>
       <li class="none"><a href="../../../fulcrum/fulcrum-crypto/" title="Crypto Service">Crypto Service</a></li>
       <li class="none"><a href="../../../fulcrum/fulcrum-cache/" title="Cache Service">Cache Service</a></li>
       <li class="none"><a href="../../../fulcrum/fulcrum-factory/" title="Factory Service">Factory Service</a></li>
       <li class="none"><a href="../../../fulcrum/fulcrum-intake/" title="Intake Service">Intake Service</a></li>
       <li class="none"><a href="../services/jsonrpc-service.html" title="JSON-RPC Service">JSON-RPC Service</a></li>
       <li class="none"><a href="../../../fulcrum/fulcrum-json/" title="JSON Service">JSON Service</a></li>
       <li class="none"><a href="../services/jsp-service.html" title="JSP Service">JSP Service</a></li>
       <li class="none"><a href="../../../fulcrum/fulcrum-localization/" title="Localization Service">Localization Service</a></li>
       <li class="none"><a href="../../../fulcrum/fulcrum-mimetype/" title="MimeType Service">MimeType Service</a></li>
       <li class="none"><a href="../services/naming-service.html" title="Naming Service">Naming Service</a></li>
       <li class="none"><a href="../../../fulcrum/fulcrum-parser/" title="Parser Service">Parser Service</a></li>
       <li class="none"><a href="../../../fulcrum/fulcrum-pool/" title="Pool Service">Pool Service</a></li>
       <li class="none"><a href="../services/pull-service.html" title="Pull Service">Pull Service</a></li>
       <li class="none"><a href="../services/rundata-service.html" title="RunData Service">RunData Service</a></li>
       <li class="none"><strong>Scheduler Service</strong></li>
       <li class="none"><a href="../services/security-service.html" title="Security Service">Security Service</a></li>
       <li class="none"><a href="../services/servlet-service.html" title="Servlet Service">Servlet Service</a></li>
       <li class="none"><a href="../services/session-service.html" title="Session Service">Session Service</a></li>
       <li class="none"><a href="../services/template-service.html" title="Template Service">Template Service</a></li>
       <li class="none"><a href="../services/ui-service.html" title="UI Service">UI Service</a></li>
       <li class="none"><a href="../services/uniqueid-service.html" title="Unique ID Service">Unique ID Service</a></li>
       <li class="none"><a href="../../../fulcrum/fulcrum-upload/" title="Upload Service">Upload Service</a></li>
       <li class="none"><a href="../services/velocity-service.html" title="Velocity Service">Velocity Service</a></li>
       <li class="none"><a href="../../../fulcrum/fulcrum-xmlrpc/" title="XML-RPC Service">XML-RPC Service</a></li>
       <li class="none"><a href="../../../fulcrum/fulcrum-xslt/" title="XSLT Service">XSLT Service</a></li>
      </ul></li>
     <li class="collapsed"><a href="../howto/index.html" title="Howtos">Howtos</a></li>
     <li class="none"><a href="http://wiki.apache.org/turbine/FrontPage" class="externalLink" title="Wiki">Wiki</a></li>
     <li class="none"><a href="../apidocs/index.html" title="JavaDocs">JavaDocs</a></li>
    </ul>
       <h5>Development</h5>
    <ul>
     <li class="none"><a href="../proposals.html" title="Proposals">Proposals</a></li>
     <li class="none"><a href="../how-to-help.html" title="How To Help">How To Help</a></li>
     <li class="none"><a href="../todo.html" title="Todo">Todo</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="../project-info.html" title="Project Information">Project Information</a></li>
     <li class="collapsed"><a href="../project-reports.html" title="Project Reports">Project Reports</a></li>
    </ul>
       <h5>Apache</h5>
    <ul>
     <li class="none"><a href="http://www.apache.org/" class="externalLink" title="Apache Website">Apache Website</a></li>
     <li class="none"><a href="http://www.apache.org/licenses/" class="externalLink" title="License">License</a></li>
     <li class="none"><a href="http://www.apache.org/foundation/how-it-works.html" class="externalLink" title="How the ASF works">How the ASF works</a></li>
     <li class="none"><a href="http://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsorship">Sponsorship</a></li>
     <li class="none"><a href="http://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks">Thanks</a></li>
     <li class="none"><a href="http://www.apache.org/security/" class="externalLink" title="Security">Security</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="../images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">


 

<div class="section">
<h2><a name="Scheduler_Service"></a>Scheduler Service</h2>


<p>
    The Scheduler is modeled after Unix Cron. The Scheduler runs as a background
    process that executes timed scheduled tasks independently of HTTP requests.
    Tasks are either stored in the database in the TURBINE_SCHEDULED_JOB table and once
    entered in the database are loaded automatically when Turbine initializes or as a non persistent service using TurbineNonPersistentSchedulerService.
</p>


<p>
    For the Scheduler to load classes that extend the ScheduledJob Class,
    the scheduler needs to be enabled via the TurbineResources.properties
    file, where the directive services.SchedulerService.enabled needs to be
    set to true.
</p>


<p>
    The Scheduler Service should be accessed in one of two ways.
    </p>
<ul>
        
<li>
            Get an instance of type org.apache.turbine.services.schedule.ScheduleService (eihter using annnotation @TurbineService or by using static call to TurbineServices.getInstance().getService with parameter ScheduleService.SERVICE_NAME) - This interface provides  methods to access the scheduler service.  This is the preferred method of access from within java code.
        </li>
        
<li>
            org.apache.turbine.services.schedule.SchedulerTool - This is a pull
            tool for providing access to the scheduler service from within a
            Velocity template.
        </li>
    </ul>


</div>


<div class="section">
<h2><a name="Configuration"></a>Configuration</h2>


<div class="source">
<pre>
# -------------------------------------------------------------------
#
#  S E R V I C E S
#
# -------------------------------------------------------------------
# Classes for Turbine Services should be defined here.
# Format: services.[name].classname=[implementing class]
#
# To specify properties of a service use the following syntax:
# service.[name].[property]=[value]

services.SchedulerService.classname=org.apache.turbine.services.schedule.QuartzSchedulerService
.
.
.
# -------------------------------------------------------------------
#
#  S C H E D U L E R  S E R V I C E
#
# -------------------------------------------------------------------

#
# Set enabled to true to start the scheduler.  The scheduler can be
# stopped and started after Turbine has been intialized.  See the
# javadocs for org.apache.turbine.services.schedule.TurbineScheduler
# for the methods calls.
#
# Default = false
#

services.SchedulerService.enabled=false

# Determines if the scheduler service should be initialized early.  This
# Should always be set to true!!!!

services.SchedulerService.earlyInit=true

# -------------------------------------------------------------------
#
#  P U L L  S E R V I C E
#
# -------------------------------------------------------------------
# These are the properties for the Pull Service, the service
# that works in conjuction with the Turbine Pull Model API.
# -------------------------------------------------------------------

# This is a tool that allows access to the scheduler service.
tool.request.scheduler=org.apache.turbine.services.schedule.SchedulerTool

</pre></div>


<p>
    Jobs are stored and retrieved from the database using Torque
    generated objects.  The objects are based on the definition
    stored in <tt>scheduler-schema.xml</tt>.  If you want to
    add additional fields to track more information about your
    scheduled tasks, you can modify this file to do so.  You will
    need to rebuild Turbine using MAven after making your modifications.
</p>

</div>


<div class="section">
<h2><a name="Usage"></a>Usage</h2>


<p>
To create an object that takes advantage of the Schedule Service, the task
to be executed will need to be embedded in the run() method of an object
which extends the ScheduledJob Class. For instance:
</p>


<div class="source">
<pre>

package com.mycompany.modules.scheduledjobs;


//JDK
import java.util.Date;

//Turbine
import org.apache.turbine.modules.ScheduledJob;
import org.apache.turbine.services.schedule.JobEntry;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;


public class SimpleScheduledTask extends ScheduledJob
{
    /** Logging */
    private static Log log = LogFactory.getLog(SimpleScheduledTask.class);

    private int taskcount = 0;

    /**
     * Constructor
     */
     public SimpleScheduledTask()
     {
         //do Task initialization here
     }


    /**
     * Run the Jobentry from the scheduler queue.
     * From ScheduledJob.
     *
     * @param job The job to run.
     */
    public void run( JobEntry job ) throws Exception
    {
        log.note(&quot;Scheduled job &quot; + job.getJobId() + &quot; : &quot; +
                 &quot;task: &quot; + job.getTask() +
                 &quot; ran @: &quot; +
                 new Date(System.currentTimeMillis()).toString() +
                 &quot; taskcount &quot; + taskcount
                 );
        //iterate the task counter
        taskcount++;
    }
}

</pre></div>


<p>
The SimpleScheduledTask object makes an entry into the turbine.log each
time the Task is run by the Schedule Service. The JobEntry object carries the
information the Service uses to determine the frequency of the Task.
Note that the object is in the com.mycompany.modules. This assumes that the
package com.mycompany.modules is in the Turbine module path, which is in the
module.packages directive in the TurbineResources.properties.
The ScheduledJobLoader object loads the Task upon Turbine initilization also
searches for a <i>scheduledjobs</i> package which contains the Task object.
</p>


<p>
Control of the time between, or to, execution of the Task, is controlled by
the JobEntry object. The JobEntry serves as a wrapper for the scheduled task.
The constructor is as follows:
</p>


<div class="source">
<pre>

public JobEntry(int sec, int min, int hour,
                int wd, int day_mo, String task)
                throws Exception

</pre></div>


<p>
The granularity of the Task's next execution can be controlled to the level
of seconds. In the above constructor, sec represents the seconds with a valid
range of 0-59, min represents the minutes with a valid range of 0-59,
hour represents the hours with a valid range of 0-23, wd is the day of the
week with a valid range of 1-7, day_mo is the day of the month with a valid
range of 1-31 and task is the name of the object. The JobEntry constructor
allows for the Task to be run at a certain point in time. For example:
</p>


<div class="source">
<pre>

JobEntry je = new JobEntry(0,25,-1,-1,-1,&quot;SimpleScheduledTask&quot;);

  o run every 25 minutes.

JobEntry je = new JobEntry(0,0,8,-1,15,&quot;SimpleScheduledTask&quot;);

  o run at 8:00am on the 15th of the month every month.

</pre></div>


<p>
The Schedule Service will only execute Tasks at Turbine Initialization that
are present in the Database. To add a Task to the Database we need to set up
an Action class that can be accessed from a template with:
</p>


<div class="source">
<pre>

$page.SetTitle(&quot;SimpleScheduleTask Starter Page&quot;)

Set Values for SimpleScheduleTask and then start it for the first time.
&lt;br /&gt;

&lt;form&gt;
&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;SchedulerStart&quot; /&gt;
&lt;input type=&quot;text&quot; name=&quot;second&quot; size=&quot;20&quot; /&gt; : seconds (0-59)&lt;br /&gt;
&lt;input type=&quot;text&quot; name=&quot;minute&quot; size=&quot;20&quot; /&gt; : minutes (0-59)&lt;br /&gt;
&lt;input type=&quot;text&quot; name=&quot;hour&quot; size=&quot;20&quot; /&gt; : hours (0-23)&lt;br /&gt;
&lt;input type=&quot;text&quot; name=&quot;weekday&quot; size=&quot;20&quot; /&gt; : Day of the Week (1-7)&lt;br /&gt;
&lt;input type=&quot;text&quot; name=&quot;day_of_month&quot; size=&quot;20&quot; /&gt; Day of the Month (1-31)&lt;br /&gt;
&lt;input type=&quot;text&quot; name=&quot;task&quot; value=&quot;SimpleSchedulerTask&quot; /&gt; : The Task being scheduled. &lt;br /&gt;
&lt;input type=&quot;text&quot; name=&quot;email&quot; /&gt; : Email&lt;br /&gt;
&lt;/form&gt;

</pre></div>


<p>
and the appropriate Action class:
</p>


<div class="source">
<pre>

package com.mycompany.modules.actions;


//Turbine
import org.apache.turbine.modules.actions.VelocityAction;
import org.apache.turbine.services.schedule.JobEntry;
import org.apache.turbine.services.schedule.TurbineScheduler;
import org.apache.turbine.services.TurbineServices;
import org.apache.turbine.util.ParameterParser;
import org.apache.turbine.util.RunData;


public class AddScheduledTask extends VelocityAction
{

     public void doPerform(RunData data) throws Exception
     {
        ParameterParser params = data.getParameters();

        int second = params.getInt(&quot;second&quot;,-1);
        int minute = params.getInt(&quot;minute&quot;,-1);
        int hour = params.getInt(&quot;hour&quot;,-1);
        int weekday = params.getInt(&quot;weekday&quot;,-1);
        int dom = params.getInt(&quot;day_of_month&quot;,-1);
        String task = params.getString(&quot;task&quot;,&quot;&quot;);
        String email = params.getString(&quot;email&quot;,&quot;&quot;);

        try
        {
            //create a new JobEntry with the time constraints from
            //the template as the arguments
            JobEntry je =  new JobEntry(second,minute,hour,weekday,dom,task);

            //set the email for notification
            je.setEmail(email);

            //add the job to the queue
            TurbineScheduler.addJob(je);

            //set the Message
            data.setMessage(&quot;Task &quot; + task + &quot; added successfully&quot;);
        }
        catch (Exception e)
        {
            //set the Message
            data.setMessage(&quot;Task &quot; + task + &quot; could not be added!&quot;);
        }

        // Note: The template &quot;SchedulerStatus.vm&quot; is not part of Turbine.
        // It is only here as an example how you might implement this action.
        setTemplate(data, &quot;SchedulerStatus.vm&quot;);

     }
}

</pre></div>


<p>
    The AddScheduledTask action class adds the task to the job queue.  The job
    will also be written to database so that it will be automatically loaded
    the next time that Turbine starts.
</p>

<p>
    The AddScheduledTask action class is really only part of what you would need
    to implement in order to control the job scheduler from a web interface.  It
    is given as a VERY simple example of how you might implement such functionality.
    In a more complete implementation, you would have templates to create/edit a scheduled
    task, display all tasks, and control the scheduler.  You would also have action(s)
    to enable/disable the scheduler and add/update/remove scheduled tasks.
</p>

<p>
    The TurbineScheduler class exposes methods that allow the
    Scheduler process to be monitored and controlled, such as getJob(int oid),
    removeJob(JobEntry je), updateJob(JobEntry je), listJobs(), startScheduler(),
    stopScheduler(), and others.  See the javadocs on this class for more details.
</p>

<p>
    There is also a pull tool for use with the scheduler service (assuming the pull service
    is enabled).  This tool allows you to get basic information from the scheduler service
    for use in a Velocity template.  It provides methods such as getJob(jobId), listJobs(),
    isEnabled(), and others.  See the javadocs for more details.
</p>


<p>
    The Scheduler Service uses a seperate thread for each Task it runs to ensure
    that every job runs on time. It's the programmer's responsibility to ensure
    that proper precautions to handle issues such as synchronization and long
    running jobs. As always, check through the relevant Javadocs and source code
    for more details on the Scheduler Service.
</p>

</div>



      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &#169;      2000&#x2013;2019 <a href="https://www.apache.org/">The Apache Software Foundation</a>.
All rights reserved.      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>