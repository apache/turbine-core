<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from xdocs/services\scheduler-service.xml at 22 September 2021
 | Rendered using Apache Maven Fluido Skin 1.9
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <title>Apache Turbine &#x2013; Turbine Services - Scheduler Service</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.9.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.9.min.js"></script>
<link rel="icon" type="image/png" sizes="48x48" href="./images/favicon.ico"> 
      <link rel="icon" type="image/png" sizes="48x48" href="../images/favicon.ico"> 
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><a href="../../" id="bannerLeft" title="Apache Turbine"><img src="../images/turbine-project-apache-separate.png"  alt="Apache Turbine"/></a></div>
          <div class="pull-right"><div id="bannerRight"><img src="../images/logo.gif"  alt=""/></div>
</div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 22 September 2021<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 5.1-SNAPSHOT</li>
      <li class="pull-right"><span class="divider">|</span>
<a href="https://turbine.apache.org/fulcrum/" class="externalLink" title="Fulcrum">Fulcrum</a></li>
      <li class="pull-right"><span class="divider">|</span>
<a href="https://turbine.apache.org/" class="externalLink" title="Turbine">Turbine</a></li>
      <li class="pull-right"><a href="https://www.apache.org" class="externalLink" title="Apache">Apache</a></li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">General Information</li>
    <li><a href="../index.html" title="Overview"><span class="none"></span>Overview</a></li>
    <li><a href="../features.html" title="Features"><span class="none"></span>Features</a></li>
    <li><a href="../fsd.html" title="Specification"><span class="none"></span>Specification</a></li>
    <li><a href="../getting-started.html" title="Getting Started"><span class="none"></span>Getting Started</a></li>
    <li><a href="../how-to-build.html" title="Howto Build Turbine"><span class="none"></span>Howto Build Turbine</a></li>
    <li><a href="../changes-report.html" title="Changes"><span class="none"></span>Changes</a></li>
   <li class="nav-header">Documentation</li>
    <li><a href="../services/index.html" title="Services"><span class="icon-chevron-down"></span>Services</a>
     <ul class="nav nav-list">
      <li><a href="../services/assemblerbroker-service.html" title="Assembler Broker Service"><span class="none"></span>Assembler Broker Service</a></li>
      <li><a href="../services/avalon-component-service.html" title="Avalon Component Service"><span class="none"></span>Avalon Component Service</a></li>
      <li><a href="../../fulcrum/fulcrum-crypto/" title="Crypto Service"><span class="none"></span>Crypto Service</a></li>
      <li><a href="../../fulcrum/fulcrum-cache/" title="Cache Service"><span class="none"></span>Cache Service</a></li>
      <li><a href="../../fulcrum/fulcrum-factory/" title="Factory Service"><span class="none"></span>Factory Service</a></li>
      <li><a href="../../fulcrum/fulcrum-intake/" title="Intake Service"><span class="none"></span>Intake Service</a></li>
      <li><a href="../services/jsonrpc-service.html" title="JSON-RPC Service"><span class="none"></span>JSON-RPC Service</a></li>
      <li><a href="../../fulcrum/fulcrum-json/" title="JSON Service"><span class="none"></span>JSON Service</a></li>
      <li><a href="../services/jsp-service.html" title="JSP Service"><span class="none"></span>JSP Service</a></li>
      <li><a href="../../fulcrum/fulcrum-localization/" title="Localization Service"><span class="none"></span>Localization Service</a></li>
      <li><a href="../../fulcrum/fulcrum-mimetype/" title="MimeType Service"><span class="none"></span>MimeType Service</a></li>
      <li><a href="../services/naming-service.html" title="Naming Service"><span class="none"></span>Naming Service</a></li>
      <li><a href="../../fulcrum/fulcrum-parser/" title="Parser Service"><span class="none"></span>Parser Service</a></li>
      <li><a href="../../fulcrum/fulcrum-pool/" title="Pool Service"><span class="none"></span>Pool Service</a></li>
      <li><a href="../services/pull-service.html" title="Pull Service"><span class="none"></span>Pull Service</a></li>
      <li><a href="../services/rundata-service.html" title="RunData Service"><span class="none"></span>RunData Service</a></li>
      <li class="active"><a href="#"><span class="none"></span>Scheduler Service</a></li>
      <li><a href="../services/security-service.html" title="Security Service"><span class="none"></span>Security Service</a></li>
      <li><a href="../services/servlet-service.html" title="Servlet Service"><span class="none"></span>Servlet Service</a></li>
      <li><a href="../services/session-service.html" title="Session Service"><span class="none"></span>Session Service</a></li>
      <li><a href="../services/template-service.html" title="Template Service"><span class="none"></span>Template Service</a></li>
      <li><a href="../services/ui-service.html" title="UI Service"><span class="none"></span>UI Service</a></li>
      <li><a href="../services/uniqueid-service.html" title="Unique ID Service"><span class="none"></span>Unique ID Service</a></li>
      <li><a href="../../fulcrum/fulcrum-upload/" title="Upload Service"><span class="none"></span>Upload Service</a></li>
      <li><a href="../services/velocity-service.html" title="Velocity Service"><span class="none"></span>Velocity Service</a></li>
      <li><a href="../../fulcrum/fulcrum-xmlrpc/" title="XML-RPC Service"><span class="none"></span>XML-RPC Service</a></li>
      <li><a href="../../fulcrum/fulcrum-xslt/" title="XSLT Service"><span class="none"></span>XSLT Service</a></li>
     </ul></li>
    <li><a href="../howto/index.html" title="Howtos"><span class="icon-chevron-right"></span>Howtos</a></li>
    <li><a href="https://cwiki.apache.org/confluence/display/TURBINE" class="externalLink" title="Wiki"><span class="none"></span>Wiki</a></li>
    <li><a href="../apidocs/index.html" title="JavaDocs"><span class="none"></span>JavaDocs</a></li>
   <li class="nav-header">Development</li>
    <li><a href="../proposals.html" title="Proposals"><span class="none"></span>Proposals</a></li>
    <li><a href="../how-to-help.html" title="How To Help"><span class="none"></span>How To Help</a></li>
    <li><a href="../todo.html" title="Todo"><span class="none"></span>Todo</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
   <li class="nav-header">Apache</li>
    <li><a href="https://www.apache.org/" class="externalLink" title="Apache Website"><span class="none"></span>Apache Website</a></li>
    <li><a href="https://www.apache.org/licenses/" class="externalLink" title="License"><span class="none"></span>License</a></li>
    <li><a href="https://www.apache.org/foundation/how-it-works.html" class="externalLink" title="How the ASF works"><span class="none"></span>How the ASF works</a></li>
    <li><a href="https://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsorship"><span class="none"></span>Sponsorship</a></li>
    <li><a href="https://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks"><span class="none"></span>Thanks</a></li>
    <li><a href="https://www.apache.org/security/" class="externalLink" title="Security"><span class="none"></span>Security</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <hr />
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >


 

<section>
<h2><a name="Scheduler_Service"></a>Scheduler Service</h2>


<p>
    The Scheduler is modeled after Unix Cron. The Scheduler runs as a background
    process that executes timed scheduled tasks independently of HTTP requests.
    Tasks are either stored in the database in the TURBINE_SCHEDULED_JOB table and once
    entered in the database are loaded automatically when Turbine initializes or as a non persistent service using TurbineNonPersistentSchedulerService.
</p>


<p>
    For the Scheduler to load classes that extend the ScheduledJob Class,
    the scheduler needs to be enabled via the TurbineResources.properties
    file, where the directive services.SchedulerService.enabled needs to be
    set to true.
</p>


<p>
    The Scheduler Service should be accessed in one of two ways.
    </p>
<ul>
        
<li>
            Get an instance of type org.apache.turbine.services.schedule.ScheduleService (eihter using annnotation @TurbineService or by using static call to TurbineServices.getInstance().getService with parameter ScheduleService.SERVICE_NAME) - This interface provides  methods to access the scheduler service.  This is the preferred method of access from within java code.
        </li>
        
<li>
            org.apache.turbine.services.schedule.SchedulerTool - This is a pull
            tool for providing access to the scheduler service from within a
            Velocity template.
        </li>
    </ul>


</section>

<section>
<h2><a name="Configuration"></a>Configuration</h2>


<div class="source"><pre class="prettyprint">
# -------------------------------------------------------------------
#
#  S E R V I C E S
#
# -------------------------------------------------------------------
# Classes for Turbine Services should be defined here.
# Format: services.[name].classname=[implementing class]
#
# To specify properties of a service use the following syntax:
# service.[name].[property]=[value]

services.SchedulerService.classname=org.apache.turbine.services.schedule.QuartzSchedulerService
.
.
.
# -------------------------------------------------------------------
#
#  S C H E D U L E R  S E R V I C E
#
# -------------------------------------------------------------------

#
# Set enabled to true to start the scheduler.  The scheduler can be
# stopped and started after Turbine has been intialized.  See the
# javadocs for org.apache.turbine.services.schedule.TurbineScheduler
# for the methods calls.
#
# Default = false
#

services.SchedulerService.enabled=false

# Determines if the scheduler service should be initialized early.  This
# Should always be set to true!!!!

services.SchedulerService.earlyInit=true

# -------------------------------------------------------------------
#
#  P U L L  S E R V I C E
#
# -------------------------------------------------------------------
# These are the properties for the Pull Service, the service
# that works in conjuction with the Turbine Pull Model API.
# -------------------------------------------------------------------

# This is a tool that allows access to the scheduler service.
tool.request.scheduler=org.apache.turbine.services.schedule.SchedulerTool

</pre></div>


<p>
    Jobs are stored and retrieved from the database using Torque
    generated objects.  The objects are based on the definition
    stored in <code>scheduler-schema.xml</code>.  If you want to
    add additional fields to track more information about your
    scheduled tasks, you can modify this file to do so.  You will
    need to rebuild Turbine using MAven after making your modifications.
</p>

</section>

<section>
<h2><a name="Usage"></a>Usage</h2>


<p>
To create an object that takes advantage of the Schedule Service, the task
to be executed will need to be embedded in the run() method of an object
which extends the ScheduledJob Class. For instance:
</p>


<div class="source"><pre class="prettyprint">

package com.mycompany.modules.scheduledjobs;


//JDK
import java.util.Date;

//Turbine
import org.apache.turbine.modules.ScheduledJob;
import org.apache.turbine.services.schedule.JobEntry;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;


public class SimpleScheduledTask extends ScheduledJob
{
    /** Logging */
    private static Log log = LogFactory.getLog(SimpleScheduledTask.class);

    private int taskcount = 0;

    /**
     * Constructor
     */
     public SimpleScheduledTask()
     {
         //do Task initialization here
     }


    /**
     * Run the Jobentry from the scheduler queue.
     * From ScheduledJob.
     *
     * @param job The job to run.
     */
    public void run( JobEntry job ) throws Exception
    {
        log.note(&quot;Scheduled job &quot; + job.getJobId() + &quot; : &quot; +
                 &quot;task: &quot; + job.getTask() +
                 &quot; ran @: &quot; +
                 new Date(System.currentTimeMillis()).toString() +
                 &quot; taskcount &quot; + taskcount
                 );
        //iterate the task counter
        taskcount++;
    }
}

</pre></div>


<p>
The SimpleScheduledTask object makes an entry into the turbine.log each
time the Task is run by the Schedule Service. The JobEntry object carries the
information the Service uses to determine the frequency of the Task.
Note that the object is in the com.mycompany.modules. This assumes that the
package com.mycompany.modules is in the Turbine module path, which is in the
module.packages directive in the TurbineResources.properties.
The ScheduledJobLoader object loads the Task upon Turbine initilization also
searches for a <i>scheduledjobs</i> package which contains the Task object.
</p>


<p>
Control of the time between, or to, execution of the Task, is controlled by
the JobEntry object. The JobEntry serves as a wrapper for the scheduled task.
The constructor is as follows:
</p>


<div class="source"><pre class="prettyprint">

public JobEntry(int sec, int min, int hour,
                int wd, int day_mo, String task)
                throws Exception

</pre></div>


<p>
The granularity of the Task's next execution can be controlled to the level
of seconds. In the above constructor, sec represents the seconds with a valid
range of 0-59, min represents the minutes with a valid range of 0-59,
hour represents the hours with a valid range of 0-23, wd is the day of the
week with a valid range of 1-7, day_mo is the day of the month with a valid
range of 1-31 and task is the name of the object. The JobEntry constructor
allows for the Task to be run at a certain point in time. For example:
</p>


<div class="source"><pre class="prettyprint">

JobEntry je = new JobEntry(0,25,-1,-1,-1,&quot;SimpleScheduledTask&quot;);

  o run every 25 minutes.

JobEntry je = new JobEntry(0,0,8,-1,15,&quot;SimpleScheduledTask&quot;);

  o run at 8:00am on the 15th of the month every month.

</pre></div>


<p>
The Schedule Service will only execute Tasks at Turbine Initialization that
are present in the Database. To add a Task to the Database we need to set up
an Action class that can be accessed from a template with:
</p>


<div class="source"><pre class="prettyprint">

$page.SetTitle(&quot;SimpleScheduleTask Starter Page&quot;)

Set Values for SimpleScheduleTask and then start it for the first time.
&lt;br /&gt;

&lt;form&gt;
&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;SchedulerStart&quot; /&gt;
&lt;input type=&quot;text&quot; name=&quot;second&quot; size=&quot;20&quot; /&gt; : seconds (0-59)&lt;br /&gt;
&lt;input type=&quot;text&quot; name=&quot;minute&quot; size=&quot;20&quot; /&gt; : minutes (0-59)&lt;br /&gt;
&lt;input type=&quot;text&quot; name=&quot;hour&quot; size=&quot;20&quot; /&gt; : hours (0-23)&lt;br /&gt;
&lt;input type=&quot;text&quot; name=&quot;weekday&quot; size=&quot;20&quot; /&gt; : Day of the Week (1-7)&lt;br /&gt;
&lt;input type=&quot;text&quot; name=&quot;day_of_month&quot; size=&quot;20&quot; /&gt; Day of the Month (1-31)&lt;br /&gt;
&lt;input type=&quot;text&quot; name=&quot;task&quot; value=&quot;SimpleSchedulerTask&quot; /&gt; : The Task being scheduled. &lt;br /&gt;
&lt;input type=&quot;text&quot; name=&quot;email&quot; /&gt; : Email&lt;br /&gt;
&lt;/form&gt;

</pre></div>


<p>
and the appropriate Action class:
</p>


<div class="source"><pre class="prettyprint">

package com.mycompany.modules.actions;


//Turbine
import org.apache.turbine.modules.actions.VelocityAction;
import org.apache.turbine.services.schedule.JobEntry;
import org.apache.turbine.services.schedule.TurbineScheduler;
import org.apache.turbine.services.TurbineServices;
import org.apache.turbine.util.ParameterParser;
import org.apache.turbine.util.RunData;


public class AddScheduledTask extends VelocityAction
{

     public void doPerform(RunData data) throws Exception
     {
        ParameterParser params = data.getParameters();

        int second = params.getInt(&quot;second&quot;,-1);
        int minute = params.getInt(&quot;minute&quot;,-1);
        int hour = params.getInt(&quot;hour&quot;,-1);
        int weekday = params.getInt(&quot;weekday&quot;,-1);
        int dom = params.getInt(&quot;day_of_month&quot;,-1);
        String task = params.getString(&quot;task&quot;,&quot;&quot;);
        String email = params.getString(&quot;email&quot;,&quot;&quot;);

        try
        {
            //create a new JobEntry with the time constraints from
            //the template as the arguments
            JobEntry je =  new JobEntry(second,minute,hour,weekday,dom,task);

            //set the email for notification
            je.setEmail(email);

            //add the job to the queue
            TurbineScheduler.addJob(je);

            //set the Message
            data.setMessage(&quot;Task &quot; + task + &quot; added successfully&quot;);
        }
        catch (Exception e)
        {
            //set the Message
            data.setMessage(&quot;Task &quot; + task + &quot; could not be added!&quot;);
        }

        // Note: The template &quot;SchedulerStatus.vm&quot; is not part of Turbine.
        // It is only here as an example how you might implement this action.
        setTemplate(data, &quot;SchedulerStatus.vm&quot;);

     }
}

</pre></div>


<p>
    The AddScheduledTask action class adds the task to the job queue.  The job
    will also be written to database so that it will be automatically loaded
    the next time that Turbine starts.
</p>

<p>
    The AddScheduledTask action class is really only part of what you would need
    to implement in order to control the job scheduler from a web interface.  It
    is given as a VERY simple example of how you might implement such functionality.
    In a more complete implementation, you would have templates to create/edit a scheduled
    task, display all tasks, and control the scheduler.  You would also have action(s)
    to enable/disable the scheduler and add/update/remove scheduled tasks.
</p>

<p>
    The TurbineScheduler class exposes methods that allow the
    Scheduler process to be monitored and controlled, such as getJob(int oid),
    removeJob(JobEntry je), updateJob(JobEntry je), listJobs(), startScheduler(),
    stopScheduler(), and others.  See the javadocs on this class for more details.
</p>

<p>
    There is also a pull tool for use with the scheduler service (assuming the pull service
    is enabled).  This tool allows you to get basic information from the scheduler service
    for use in a Velocity template.  It provides methods such as getJob(jobId), listJobs(),
    isEnabled(), and others.  See the javadocs for more details.
</p>


<p>
    The Scheduler Service uses a seperate thread for each Task it runs to ensure
    that every job runs on time. It's the programmer's responsibility to ensure
    that proper precautions to handle issues such as synchronization and long
    running jobs. As always, check through the relevant Javadocs and source code
    for more details on the Scheduler Service.
</p>

</section>



        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>&#169;      2000&#x2013;2021
<a href="https://www.apache.org/">The Apache Software Foundation</a>
</p>
        </div>
      </div>
    </footer>
  </body>
</html>
