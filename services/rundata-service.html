<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.2 from xdocs/services\rundata-service.xml at 14 December 2021
 | Rendered using Apache Maven Fluido Skin 1.9
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.2" />
    <title>Apache Turbine &#x2013; Turbine Services - RunData Service</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.9.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.9.min.js"></script>
<link rel="icon" type="image/png" sizes="48x48" href="./images/favicon.ico"> 
      <link rel="icon" type="image/png" sizes="48x48" href="../images/favicon.ico"> 
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><a href="../../" id="bannerLeft" title="Apache Turbine"><img src="../images/turbine-project-apache-separate.png"  alt="Apache Turbine"/></a></div>
          <div class="pull-right"><div id="bannerRight"><img src="../images/logo.gif"  alt=""/></div>
</div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 14 December 2021<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 5.1</li>
      <li class="pull-right"><span class="divider">|</span>
<a href="https://turbine.apache.org/fulcrum/" class="externalLink" title="Fulcrum">Fulcrum</a></li>
      <li class="pull-right"><span class="divider">|</span>
<a href="https://turbine.apache.org/" class="externalLink" title="Turbine">Turbine</a></li>
      <li class="pull-right"><a href="https://www.apache.org" class="externalLink" title="Apache">Apache</a></li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">General Information</li>
    <li><a href="../index.html" title="Overview"><span class="none"></span>Overview</a></li>
    <li><a href="../features.html" title="Features"><span class="none"></span>Features</a></li>
    <li><a href="../fsd.html" title="Specification"><span class="none"></span>Specification</a></li>
    <li><a href="../getting-started.html" title="Getting Started"><span class="none"></span>Getting Started</a></li>
    <li><a href="../how-to-build.html" title="Howto Build Turbine"><span class="none"></span>Howto Build Turbine</a></li>
    <li><a href="../changes-report.html" title="Changes"><span class="none"></span>Changes</a></li>
   <li class="nav-header">Documentation</li>
    <li><a href="../services/index.html" title="Services"><span class="icon-chevron-down"></span>Services</a>
     <ul class="nav nav-list">
      <li><a href="../services/assemblerbroker-service.html" title="Assembler Broker Service"><span class="none"></span>Assembler Broker Service</a></li>
      <li><a href="../services/avalon-component-service.html" title="Avalon Component Service"><span class="none"></span>Avalon Component Service</a></li>
      <li><a href="../../fulcrum/fulcrum-crypto/" title="Crypto Service"><span class="none"></span>Crypto Service</a></li>
      <li><a href="../../fulcrum/fulcrum-cache/" title="Cache Service"><span class="none"></span>Cache Service</a></li>
      <li><a href="../../fulcrum/fulcrum-factory/" title="Factory Service"><span class="none"></span>Factory Service</a></li>
      <li><a href="../../fulcrum/fulcrum-intake/" title="Intake Service"><span class="none"></span>Intake Service</a></li>
      <li><a href="../services/jsonrpc-service.html" title="JSON-RPC Service"><span class="none"></span>JSON-RPC Service</a></li>
      <li><a href="../../fulcrum/fulcrum-json/" title="JSON Service"><span class="none"></span>JSON Service</a></li>
      <li><a href="../services/jsp-service.html" title="JSP Service"><span class="none"></span>JSP Service</a></li>
      <li><a href="../../fulcrum/fulcrum-localization/" title="Localization Service"><span class="none"></span>Localization Service</a></li>
      <li><a href="../../fulcrum/fulcrum-mimetype/" title="MimeType Service"><span class="none"></span>MimeType Service</a></li>
      <li><a href="../services/naming-service.html" title="Naming Service"><span class="none"></span>Naming Service</a></li>
      <li><a href="../../fulcrum/fulcrum-parser/" title="Parser Service"><span class="none"></span>Parser Service</a></li>
      <li><a href="../../fulcrum/fulcrum-pool/" title="Pool Service"><span class="none"></span>Pool Service</a></li>
      <li><a href="../services/pull-service.html" title="Pull Service"><span class="none"></span>Pull Service</a></li>
      <li class="active"><a href="#"><span class="none"></span>RunData Service</a></li>
      <li><a href="../services/scheduler-service.html" title="Scheduler Service"><span class="none"></span>Scheduler Service</a></li>
      <li><a href="../services/security-service.html" title="Security Service"><span class="none"></span>Security Service</a></li>
      <li><a href="../services/servlet-service.html" title="Servlet Service"><span class="none"></span>Servlet Service</a></li>
      <li><a href="../services/session-service.html" title="Session Service"><span class="none"></span>Session Service</a></li>
      <li><a href="../services/template-service.html" title="Template Service"><span class="none"></span>Template Service</a></li>
      <li><a href="../services/ui-service.html" title="UI Service"><span class="none"></span>UI Service</a></li>
      <li><a href="../services/uniqueid-service.html" title="Unique ID Service"><span class="none"></span>Unique ID Service</a></li>
      <li><a href="../services/urlmapper-service.html" title="URL Mapper Service"><span class="none"></span>URL Mapper Service</a></li>
      <li><a href="../../fulcrum/fulcrum-upload/" title="Upload Service"><span class="none"></span>Upload Service</a></li>
      <li><a href="../services/velocity-service.html" title="Velocity Service"><span class="none"></span>Velocity Service</a></li>
      <li><a href="../../fulcrum/fulcrum-xmlrpc/" title="XML-RPC Service"><span class="none"></span>XML-RPC Service</a></li>
      <li><a href="../../fulcrum/fulcrum-xslt/" title="XSLT Service"><span class="none"></span>XSLT Service</a></li>
     </ul></li>
    <li><a href="../howto/index.html" title="Howtos"><span class="icon-chevron-right"></span>Howtos</a></li>
    <li><a href="https://cwiki.apache.org/confluence/display/TURBINE" class="externalLink" title="Wiki"><span class="none"></span>Wiki</a></li>
    <li><a href="../apidocs/index.html" title="JavaDocs"><span class="none"></span>JavaDocs</a></li>
   <li class="nav-header">Development</li>
    <li><a href="../proposals.html" title="Proposals"><span class="none"></span>Proposals</a></li>
    <li><a href="../how-to-help.html" title="How To Help"><span class="none"></span>How To Help</a></li>
    <li><a href="../todo.html" title="Todo"><span class="none"></span>Todo</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
   <li class="nav-header">Apache</li>
    <li><a href="https://www.apache.org/" class="externalLink" title="Apache Website"><span class="none"></span>Apache Website</a></li>
    <li><a href="https://www.apache.org/licenses/" class="externalLink" title="License"><span class="none"></span>License</a></li>
    <li><a href="https://www.apache.org/foundation/how-it-works.html" class="externalLink" title="How the ASF works"><span class="none"></span>How the ASF works</a></li>
    <li><a href="https://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsorship"><span class="none"></span>Sponsorship</a></li>
    <li><a href="https://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks"><span class="none"></span>Thanks</a></li>
    <li><a href="https://www.apache.org/security/" class="externalLink" title="Security"><span class="none"></span>Security</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <hr />
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >


 

<section>
<h2><a name="RunData_Service"></a>RunData Service</h2>


<p>
RunData is an interface that is passed around within Turbine. RunData
provides the threading mechanism, as there is one RunData object per
HTTP request. The RunData service manages the isues surrounding multiple
requests being accepted. TurbineRunData is the interface that is
specific to the Turbine RunData service, and via the recyclable
interface can be sent back to the Factory for recycling.
</p>


<p>
RunData objects should never be held on to across requests. They are
considered one time only objects.
</p>


<p>
All this higher level processing by the service means that for each HTTP
request there is an interface that is castable to, or available, that
can be used to access all information to do with that request. As an
example, information such as the content type of the request and the
response can be queried or sent, as well as other information
surrounding servlet HTTP management, such as Sessions, PrintWriters as
well as Turbine specific information such as Users, AccessControlLists,
Templating, Error Handling and Contexts.
</p>

</section>

<section>
<h2><a name="Configuration"></a>Configuration</h2>


<p>
In the TurbineResources.properties the service needs to be defined for
Turbine to initialize with.
</p>



<div class="source"><pre class="prettyprint">
# -------------------------------------------------------------------
#
#  S E R V I C E S
#
# -------------------------------------------------------------------
# Classes for Turbine Services should be defined here.
# Format: services.[name].classname=[implementing class]
#
# To specify properties of a service use the following syntax:
# service.[name].[property]=[value]

services.TurbineRunDataService.classname=org.apache.turbine.services.rundata.TurbineRunDataService
.
.
.
# -------------------------------------------------------------------
#
#  R U N   D A T A   S E R V I C E
#
# -------------------------------------------------------------------
# Default implementations of base interfaces for request processing.
# Additional configurations can be defined by using other keys
# in the place of the &lt;default&gt; key.
# -------------------------------------------------------------------

services.RunDataService.default.run.data=org.apache.turbine.services.rundata.DefaultTurbineRunData
services.RunDataService.default.parameter.parser=org.apache.turbine.util.parser.DefaultParameterParser
services.RunDataService.default.cookie.parser=org.apache.turbine.util.parser.DefaultCookieParser
</pre></div>

</section>

<section>
<h2><a name="Using_RunData"></a>Using RunData</h2>


<p>
As RunData encapsulates all aspects of Turbine's gathering the
HttpRequest and sending the HttpResponse, any status to do with the
Request can be queried and any manipulation of the final response can be
carried out through the RunData Object.
</p>


<p>
Turbine is a servlet and the functionality equated with the
javax.servlet and javax.servlet.http can be manipulated through the
RunData interface. One of the most useful components of the Servlet
libraries was Sessions. These are accessed through RunData; it also
provides direct access to the PrintWriter, Server details, Content
Types, ContextPath, Redirections, Client details, etc. Some of the
functions which equate with the servlet libraries are:
</p>


<div class="source"><pre class="prettyprint">
getLocale()
setLocale(Locale locale)
getCharSet()
setCharSet(String charset)
getContentType()
setContentType(String mimetype)
getOut()  //get PrintWriter Object
getRedirectURI()
getRemoteAddr()
getRemoteHost()
getRequest()
getResponse()
getServletContext()
getSession()
getStatusCode()
</pre></div>


<p>
The get/setLocale(), get/setCharSet() and get/setContentType() methods
are used for specifying the locale, character encoding and content type
of the body of the servlet response.
</p>


<p>
The method setLocale() is called to specify explicitly the locale
of the response. If setLocale() is not called, the &quot;locale.default.language&quot;
and &quot;locale.default.country&quot; properties from Turbine Resources are used to
determine the locale. If these properties are not set, the JVM's default
locale determines the locale.
</p>


<p>
If the locale is set to something else than the default locale or Locale.US,
an explicit encoding is not specified with the setCharSet() method or the
&quot;locale.default.charset&quot; property, and the main MIME type of the content is
&quot;text&quot;, the getContentType() method adds a locale specific encoding (charset)
to the content type automatically.
</p>


<p>
The locale specific charset is obtained from the MimeTypeService, which
maintains mappings between locales and charsets.
</p>


<p>
As always consult the Javadocs for more detail.
</p>


<p>
To use Turbine to only manipulate the functions that came with the Sun
Servlet libraries is to miss out on Turbine's power. Turbine is a
framework which enables manipulation of the HttpResponse and HttpRequest
above and beyond the simple Servlet libraries. Turbine has services and
layers surrounding those available with the Response and Request that
allow easier creation and management of Websites and Web-enabled
Applications. In fact you wont have to type import javax.servlet.*
again!
</p>

</section>

<section>
<h2><a name="Session_Management"></a>Session Management</h2>

<p>
Sessions are managed in Turbine via the User interface. The User
interface allows for a blend of cookie management, memory management and
relational database to be used to manage a user's session. A user of the
site can have their Turbine session set as either temporary storage or
permanent storage. The permanent storage will survive a servlet engine
restart. How all this is managed by Turbine is transparent to the Java
Engineer. As an example assume we want to monitor how often a user
returns to the website we are developing and we want to reward them for
their returning interaction:
</p>


<div class="source"><pre class="prettyprint">
//in Login Action class
public void doPerform(RunData data, Context context)
    throws Exception
{
    //get the Parameters, username and password
    ParameterParser params = data.getParameters();
    String loginname = params.getString(&quot;username&quot;);
    String password = params.getString(&quot;password&quot;);

    try
    {
        //cast to TurbineUser interface
        //and check if user is in system
        TurbineUser user = (TurbineUser)
                             TurbineSecurity
                              .getAuthenticatedUser(loginname, password);

        //put User into Session
        data.setUser(user);

        //mark the User as logged in
        user.setHasLoggedIn(new Boolean(true));

        //add to the access counter
        user.incrementAccessCounter();

        //add to the access counter for the session
        user.incrementAccessCounterForSession();

        //check to see if user is to have
        //their status changed to valued
        if(user.getAccessCounter() &gt; 500 )
        {
            //set into persistant storage
            //that our visitor is now a
            //valued user
            user.setPerm(&quot;valued&quot;, new Boolean(true));
        }

        data.save();
    }
    catch (Exception e)
    {
        //error handling
    }
}
</pre></div>


<p>
While skeletal this shows a good example of permanent and temporary
management of User information. The line data.setUser() puts the User
into session, the hasLoggedIn() method updates the User Object to
reflect the fact that the session has passed Authentication; however
until the RunData's save method is called both the User and hasLoggedIn
flag are only existing in Turbine's memory. Neither become a part of
RunData's HttpSession until they are saved into the session through
data.save(). The AccessCounter is persistent storage and is saved into
the database. The AccessCounter for the session counts the number of
pages that are requested throgh Turbine for the user's session. Once
their session logs out or the session times out, that information is
lost. The user.setPerm() method allows for information to be stored
persistently into the database as a HashTable entry. The example above
was intended to show that information can be handled through a
consistent interface allowing for the management at the
request/response, session and persistent levels without any direct
manipulation of the HttpRequest, HttpResponse, HttpSession or Relational
database. As always, refer to the Javadocs for more information on the
RunData, User and TurbineUser interfaces.
</p>

</section>

<section>
<h2><a name="Parameter_and_Cookie_Parsing"></a>Parameter and Cookie Parsing</h2>

<p>
One of the most useful parts of the RunData interface is the easy
retrieval of parameters attached to a request. The ParameterParser and
CookieParser Interfaces are available through the RunData interface and
provide convenience methods for gathering parameters from either the URI
or Session. Turbine handles parameters as name/value pairs through the
URI via the BaseValueParser object, allowing the parameters to be
requested as a Java type rather than a catch-all:
</p>


<div class="source"><pre class="prettyprint">
/** the doPerform method from Invoice.java Action class */
public void doPerform(RunData data, Context context) throws Exception
{
    //get parameters
    ParameterParser params = data.getParameters();

    /**
     * Where &quot;units&quot; is the HTML Input Form name
     */
    int units = params.getInt(&quot;units&quot;);

    /**
     * Get the description, if there is no entry from the
     * HTML input form, set the default as &quot;No Description&quot;.
     */
    String description = params.getString(&quot;description&quot;,&quot;No Description&quot;);

    /**
     * If there is no total, set the value to 0.
     */
    BigDecimal total = params.getBigDecimal(&quot;total&quot;,new BigDecimal(0));
}
</pre></div>


<p>
The above example shows gathering of name/value pairs from HTML Form
Inputs and setting default values for those forms. In the case of
description, if the description is null, then the default value &quot;No
Description&quot; will be substituted. The Javadocs for ParameterParser show
more information on the methods available.
</p>

</section>

<section>
<h2><a name="Security_Management"></a>Security Management</h2>


<p>
The RunData interface also exposes security management methods and
information which are encapsulated into a request. The RunData interface
exposes the AccessControlList Object, which encapsulates the Permissions
and Roles for the Groups the User is in. The getACL() method allows for
the permission of the User to be queried against their ACL.
</p>


<div class="source"><pre class="prettyprint">
/** the doPerform method from DeleteInvoice.java Action class */
public void doPerform(RunData data, Context context) throws Exception
{
    //check if the User is authorized before
    //deleting the invoice
    AccessControlList acl =  data.getACL();
    if(acl.hasPermission(&quot;deleteinvoice&quot;))
    {
        //delete invoice logic
    }
    else
    {
        data.setMessage(&quot;You do not have permission to delete an invoice.&quot;);
        data.setTemplate(data, &quot;UnauthorizedRequest.vm&quot;);
    }
}
</pre></div>


<p>
The above example gets the AccessControlList Object for the User through
the RunData interface. The ACL is used to check against the Permissions
the User has, the PermissionSet, or a list of all permissions the User
has, most likely taken from a database. In this example, the check is
against the string &quot;deleteinvoice&quot;. If the User has the permission, they
will be able to delete the invoice, otherwise the User will get an
unauthorized request Velocity screen.
</p>

</section>

<section>
<h2><a name="Template_Management"></a>Template Management</h2>


<p>
The RunData also exposes methods to manipulate Screens, Actions, Pages
and Layouts. The templating service assembles the screens, actions and
layouts as well as exposing template methods. The methods for managing
screens and actions includes:
</p>


<div class="source"><pre class="prettyprint">
getAction()
getLayout()
getLayoutTemplate()
getScreen()
getTemplateInfo()  //returns TemplateInfo Object
hasAction()
hasScreen()
setAction()
setLayout()
setLayoutTemplate()
setScreen()
setScreenTemplate()
</pre></div>


<p>
For more information on how to use the RunData Interface with Velocity
templates and the Velocity context, view the Velocity Site
documentation.
</p>

</section>

<section>
<h2><a name="Messaging"></a>Messaging</h2>


<p>
One of the other useful wrappers the RunData interface provides access
to is messaging. The Message can be set as a String, an ECS Element or
as a FormMessages object. RunData contains access to other convenience
methods to do with Messaging such as:
</p>


<div class="source"><pre class="prettyprint">
addMessage(Element msg)
addMessage(String msg)
hasMessage()    //if the request has a message
getMessage()
getMessageAsHTML()
getMessages()   //returns a FormMessages Object
setMessage(String msg)
setMessage(Element msg)
setMessage(FormMessages msgs)
</pre></div>


<p>
An example of using messages with Velocity templates in an action is
below:
</p>


<div class="source"><pre class="prettyprint">
/** the doPerform method from Invoice.java Action class */
public void doPerform(RunData data, Context context) throws Exception
{
    data.setMessage(&quot;A message for output.&quot;);
    data.setTemplate(data, &quot;Test.vm&quot;);
}
</pre></div>


<p>
This would be accessed in the Velocity template via:
</p>


<div class="source"><pre class="prettyprint">
#*
    Velocity file, Test.vm, showing messaging example.
*#

$data.getMessage()
</pre></div>


<p>
And the output would be:
</p>


<div class="source"><pre class="prettyprint">
A message for output.
</pre></div>


<p>
The Javadocs for RunData show all the methods available through the
interface and is definitely the place to start when looking for more
information on what RunData exposes. The RunData interface is one of the
most important areas for a Java Engineer to understand and be familiar
within the Turbine Framework. Understanding RunData is of continual
benefit.
</p>

</section>



        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>&#169;      2000&#x2013;2021
<a href="https://www.apache.org/">The Apache Software Foundation</a>
</p>
        </div>
      </div>
    </footer>
  </body>
</html>
