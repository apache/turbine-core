<?xml version="1.0" encoding="UTF-8"?>
<pmd-cpd>
<duplication lines="39" tokens="232">
<file line="151" path="/Users/thomas/Dev/workspace/Turbine-Core/target/checkout/src/java/org/apache/turbine/modules/actions/sessionvalidator/TemplateSecureSessionValidator.java"/>
<file line="109" path="/Users/thomas/Dev/workspace/Turbine-Core/target/checkout/src/java/org/apache/turbine/modules/actions/sessionvalidator/TemplateSessionValidator.java"/>
<codefragment>
<![CDATA[
        else if (data.getParameters().containsKey("_session_access_counter")
                && !security.isAnonymousUser(data.getUser()))
        {
            // See comments in screens.error.InvalidState.
            if (data.getParameters().getInt("_session_access_counter")
                    < (((Integer) data.getUser().getTemp(
                    "_session_access_counter")).intValue() - 1))
            {
                if (data.getTemplateInfo().getScreenTemplate() != null)
                {
                    data.getUser().setTemp("prev_template",
                            data.getTemplateInfo().getScreenTemplate()
                            .replace('/', ','));
                    data.getTemplateInfo().setScreenTemplate(conf.getString(
                            TurbineConstants.TEMPLATE_INVALID_STATE));
                }
                else
                {
                    data.getUser().setTemp("prev_screen",
                                           data.getScreen().replace('/', ','));
                    data.setScreen(conf.getString(
                            TurbineConstants.SCREEN_INVALID_STATE));
                }
                data.getUser().setTemp("prev_parameters", data.getParameters());
                data.setAction("");
            }
        }

        // we do not want to allow both a screen and template parameter.
        // The template parameter is dominant.
        if (data.getTemplateInfo().getScreenTemplate() != null)
        {
            data.setScreen(null);
        }

        // Comply with Turbine 4.0 standards
        pipelineData.get(Turbine.class).put(User.class, data.getUser());
    }
}
]]>
</codefragment>
</duplication>
</pmd-cpd>