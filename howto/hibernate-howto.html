<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from xdocs/howto\hibernate-howto.xml at 12 February 2024
 | Rendered using Apache Maven Fluido Skin 1.9
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <title>Apache Turbine &#x2013; Hibernate Howto</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.9.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.9.min.js"></script>
<link rel="icon" type="image/png" sizes="48x48" href="./images/favicon.ico"> 
      <link rel="icon" type="image/png" sizes="48x48" href="../images/favicon.ico"> 
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  </head>
  <body class="topBarDisabled">
    <a href="https://github.com/apache/turbine-core">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png"
        alt="Fork me on GitHub">
    </a>
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><a href="../../" id="bannerLeft" title="Apache Turbine"><img src="../images/turbine-project-apache-separate.png"  alt="Apache Turbine"/></a></div>
          <div class="pull-right"><div id="bannerRight"><img src="../images/logo.gif"  alt=""/></div>
</div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 12 February 2024<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 6.1-SNAPSHOT</li>
      <li class="pull-right"><span class="divider">|</span>
<a href="https://turbine.apache.org/fulcrum/" class="externalLink" title="Fulcrum">Fulcrum</a></li>
      <li class="pull-right"><span class="divider">|</span>
<a href="https://turbine.apache.org/" class="externalLink" title="Turbine">Turbine</a></li>
      <li class="pull-right"><a href="https://www.apache.org" class="externalLink" title="Apache">Apache</a></li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">General Information</li>
    <li><a href="../index.html" title="Overview"><span class="none"></span>Overview</a></li>
    <li><a href="../features.html" title="Features"><span class="none"></span>Features</a></li>
    <li><a href="../fsd.html" title="Specification"><span class="none"></span>Specification</a></li>
    <li><a href="../getting-started.html" title="Getting Started"><span class="none"></span>Getting Started</a></li>
    <li><a href="../how-to-build.html" title="Howto Build Turbine"><span class="none"></span>Howto Build Turbine</a></li>
    <li><a href="../changes-report.html" title="Changes"><span class="none"></span>Changes</a></li>
   <li class="nav-header">Documentation</li>
    <li><a href="../services/index.html" title="Services"><span class="icon-chevron-right"></span>Services</a></li>
    <li><a href="../howto/index.html" title="Howtos"><span class="icon-chevron-down"></span>Howtos</a>
     <ul class="nav nav-list">
      <li><a href="../howto/action-event-howto.html" title="Action Events Howto"><span class="none"></span>Action Events Howto</a></li>
      <li><a href="../howto/annotations.html" title="Annotations Howto"><span class="none"></span>Annotations Howto</a></li>
      <li><a href="../howto/configuration-howto.html" title="Configuration Howto"><span class="none"></span>Configuration Howto</a></li>
      <li><a href="../howto/extend-user-howto.html" title="Extend User Howto"><span class="none"></span>Extend User Howto</a></li>
      <li class="active"><a href="#"><span class="none"></span>Hibernate OM Howto</a></li>
      <li><a href="../howto/intake-howto.html" title="Intake Howto"><span class="none"></span>Intake Howto</a></li>
      <li><a href="../howto/jsp-howto.html" title="JSP Howto"><span class="none"></span>JSP Howto</a></li>
      <li><a href="../howto/migrate-from-2_1-howto.html" title="Migrating from 2.1 to 2.2"><span class="none"></span>Migrating from 2.1 to 2.2</a></li>
      <li><a href="../howto/migrate-from-2_2-howto.html" title="Migrating from 2.2 to 2.3"><span class="none"></span>Migrating from 2.2 to 2.3</a></li>
      <li><a href="../howto/migrate-from-2_3-howto.html" title="Migrating from 2.3 to 4.0"><span class="none"></span>Migrating from 2.3 to 4.0</a></li>
      <li><a href="../howto/migrate-from-4_0-howto.html" title="Migrating from 4.0 to 5.0"><span class="none"></span>Migrating from 4.0 to 5.0</a></li>
      <li><a href="../howto/pullmodel-howto.html" title="Pull Model Howto"><span class="none"></span>Pull Model Howto</a></li>
      <li><a href="../howto/python-howto.html" title="Python Howto"><span class="none"></span>Python Howto</a></li>
      <li><a href="../howto/security-howto.html" title="Security Howto"><span class="none"></span>Security Howto</a></li>
      <li><a href="../howto/services-howto.html" title="Services Howto"><span class="none"></span>Services Howto</a></li>
      <li><a href="../howto/url-mapper-howto.html" title="URL Mapper Howto"><span class="none"></span>URL Mapper Howto</a></li>
      <li><a href="../howto/url-rewriting-howto.html" title="URL Rewriting Howto"><span class="none"></span>URL Rewriting Howto</a></li>
      <li><a href="../howto/context-howto.html" title="Velocity Context Howto"><span class="none"></span>Velocity Context Howto</a></li>
      <li><a href="../howto/velocity-site-howto.html" title="Velocity Site Howto"><span class="none"></span>Velocity Site Howto</a></li>
      <li><a href="../howto/velocityonlylayout-howto.html" title="VelocityOnlyLayout Howto"><span class="none"></span>VelocityOnlyLayout Howto</a></li>
     </ul></li>
    <li><a href="https://cwiki.apache.org/confluence/display/TURBINE" class="externalLink" title="Wiki"><span class="none"></span>Wiki</a></li>
    <li><a href="../apidocs/index.html" title="JavaDocs"><span class="none"></span>JavaDocs</a></li>
   <li class="nav-header">Development</li>
    <li><a href="../proposals.html" title="Proposals"><span class="none"></span>Proposals</a></li>
    <li><a href="../how-to-help.html" title="How To Help"><span class="none"></span>How To Help</a></li>
    <li><a href="../todo.html" title="Todo"><span class="none"></span>Todo</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
   <li class="nav-header">Apache</li>
    <li><a href="https://www.apache.org/" class="externalLink" title="Apache Website"><span class="none"></span>Apache Website</a></li>
    <li><a href="https://www.apache.org/licenses/" class="externalLink" title="License"><span class="none"></span>License</a></li>
    <li><a href="https://www.apache.org/foundation/how-it-works.html" class="externalLink" title="How the ASF works"><span class="none"></span>How the ASF works</a></li>
    <li><a href="https://www.apache.org/foundation/sponsorship.html" class="externalLink" title="Sponsorship"><span class="none"></span>Sponsorship</a></li>
    <li><a href="https://www.apache.org/foundation/thanks.html" class="externalLink" title="Thanks"><span class="none"></span>Thanks</a></li>
    <li><a href="https://www.apache.org/security/" class="externalLink" title="Security"><span class="none"></span>Security</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
<form id="search-form" action="https://www.google.com/search" method="get" >
  <input value="http://turbine.apache.org/turbine-core" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script>asyncJs( 'https://cse.google.com/brand?form=search-form' )</script>
            <hr />
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >


  

    <section>
<h2><a name="Introduction"></a>Introduction</h2>
      
<p>
        This is a HOWTO on implementing Hibernate as the database OM layer.  The motivating factors for using Hibernate
        are:
        </p>
<ol style="list-style-type: decimal">
          
<li>
      You just use POJO (Plain Old Java Objects) versus generated objects.
          </li>
          
<li>
      You can either start with Java objects and create your database schema from there, or
      start with a database schema, and map the Java objects to the schema.
          </li>
          
<li>
      Extensive performance optimizations built into the Hibernate engine.
          </li>
          
<li>
      Leverage Avalon component use in Turbine 2.3!
          </li>
        </ol>
      
      
<p>
        Please review the content available from the Hibernate homepage.  This howto assumes
        you already are confortable with the various Hibernate concepts.
      </p>
      
<p>
    In this example, we will take a simple schema with a single table and integrate Hibernate into
    a Turbine action.  We will talk about best practices for Hibernate and Turbine.
        </p>
<ol style="list-style-type: decimal">
          
<li>
        Configure project dependencies.
          </li>
          
<li>
        Directory Structures
          </li>

          
<li>
        Setup Avalon component configuration.
          </li>

          
<li>
          Setup Hibernate mapping files.
          </li>
          
<li>
          Create static ServiceLocator class.
          </li>
          
<li>
            Create filter that manages the Hibernate Session.
          </li>
          
<li>
            Setup PersitenceException handling
          </li>
        </ol>
      

    </section>

    <section>
<h2><a name="Directory_Structures"></a>Directory Structures</h2>
      
<p>
      While you can organize your directory structure however you like, I tend to have structure like:
      </p>
      
<div class="source"><pre class="prettyprint">
      /src/java/com/my/project/bizobj business objects reside
      /src/java/com/my/project/om POJO objects mapped to database reside
      /src/java/com/my/project/om/persist manager objects that faciliate retrieve POJO objects
      /src/java/com/my/project/om/filter Servlet Filter lives that maintains the Hibernate Session
      /src/java/ where hibernate.hbm.xml and hibernate.cfg.xml files live

    </pre></div>

    </section>

    <section>
<h2><a name="Configure_project_dependencies"></a>Configure project dependencies</h2>
      
<p>
        The easiest way to maintain a project is to use Maven.  Here are the sample
        dependencies for your project.xml.
      </p>
      
<div class="source"><pre class="prettyprint">

    &lt;dependency&gt;
      &lt;id&gt;hibernate&lt;/id&gt;
      &lt;version&gt;2.0-beta6&lt;/version&gt;
      &lt;properties&gt;
      &lt;war.bundle.jar&gt;true&lt;/war.bundle.jar&gt;
      &lt;/properties&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;id&gt;hibernate:hibernate-avalon&lt;/id&gt;
      &lt;version&gt;0.1&lt;/version&gt;
      &lt;properties&gt;
      &lt;war.bundle.jar&gt;true&lt;/war.bundle.jar&gt;
      &lt;/properties&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;id&gt;dom4j&lt;/id&gt;
      &lt;version&gt;1.4&lt;/version&gt;
      &lt;properties&gt;
      &lt;war.bundle.jar&gt;true&lt;/war.bundle.jar&gt;
      &lt;/properties&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;id&gt;cglib&lt;/id&gt;
      &lt;version&gt;rc2-1.0&lt;/version&gt;
      &lt;properties&gt;
      &lt;war.bundle.jar&gt;true&lt;/war.bundle.jar&gt;
      &lt;/properties&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;id&gt;jcs&lt;/id&gt;
      &lt;version&gt;1.0-dev&lt;/version&gt;
      &lt;properties&gt;
      &lt;war.bundle.jar&gt;true&lt;/war.bundle.jar&gt;
      &lt;/properties&gt;
    &lt;/dependency&gt;

      </pre></div>
      
<p>
        The key jar file is the hibernate-avalon.jar file, it contains the Avalon wrapper
        for Hibernate, and can be used with any Avalon container.
      </p>

    </section>

    <section>
<h2><a name="Setting_up_Avalon_Configuration"></a>Setting up Avalon Configuration</h2>

        
<p>
      We leverage the Avalon based HibernateService that is hosted as part of the
      HibernateExt project.  You must specify the name of the service, as well as the implementing
      service in your componentConfiguration.xml file.  Other configuration parameters can be passed
      in as well.
        </p>
      
<div class="source"><pre class="prettyprint">


&lt;my-system&gt;
  &lt;component
    role=&quot;net.sf.hibernate.avalon.HibernateService&quot;
    class=&quot;net.sf.hibernate.avalon.HibernateServiceImpl&quot;&gt;
  &lt;/component&gt;
&lt;/my-system&gt;


      </pre></div>

        
<p>
      The componentRoles file also defines how to access the component.  Here is a
      very simple componentRoles.xml file:
        </p>
      
<div class="source"><pre class="prettyprint">


&lt;role-list&gt;
 &lt;role
    name=&quot;net.sf.hibernate.avalon.HibernateService&quot;
    shorthand=&quot;hibernate&quot;
    default-class=&quot;net.sf.hibernate.avalon.HibernateServiceImpl&quot;/&gt;
&lt;/role-list&gt;


      </pre></div>
    </section>



    <section>
<h2><a name="Setup_Hibernate_mapping_files"></a>Setup Hibernate mapping files</h2>
      
<p>
    This section will not go into depth on how to configure the hibernate.cfg.xml and
    hibernate.hbm.xml files.  However, if you don't specify in the componentConfiguration.xml
    file where they are located, then they should be placed in your src/java/ directory.
      </p>
      
<p>
        The exact configuration is dependent on the environment Turbine is running in, however
        I highly recommend that you use the JNDI look up of the datasource, and use DBCP for your
        connection pooling.  I have found that when using Hibernate in cactus tests, you may need to
        increase the pool size required in order to not run out of connections, however this doesn't
        seem to apply to running as a web application.
      </p>
    </section>



    <section>
<h2><a name="Create_static_ServiceLocator_class."></a>Create static ServiceLocator class.</h2>
      
<p>
    Currently this class is not integrated into Turbine, so you will need to provide an implemation yourself.
    This provides a static method of retrieving your Hibernate Session.
      </p>

        
<div class="source"><pre class="prettyprint">

package com.upstate.cellculture.om.persist;

import net.sf.hibernate.HibernateException;
import net.sf.hibernate.JDBCException;
import net.sf.hibernate.Session;
import net.sf.hibernate.SessionFactory;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/**
 * This class is used to get Hibernate Sessions and may
 * also contain methods (in the future) to get DBConnections
 * or Transactions from JNDI.
 */
public class ServiceLocator
{
    //~ Static fields/initializers =============================================
    public final static String SESSION_FACTORY = &quot;hibernate/sessionFactory&quot;;
    public static final ThreadLocal session = new ThreadLocal();
    private static SessionFactory sf = null;
    private static ServiceLocator me;
    private static Log log = LogFactory.getLog(ServiceLocator.class);

    static {
        try
        {
            me = new ServiceLocator();
        }
        catch (Exception e)
        {
            log.fatal(&quot;Error occurred initializing ServiceLocator&quot;);
            e.printStackTrace();
        }
    }

    //~ Constructors ===========================================================

    private ServiceLocator() throws HibernateException, JDBCException
    {}

    //~ Methods ================================================================

    public static Session currentSession() throws PersistenceException
    {
        Session s = (Session) session.get();

        if (s == null)
        {
            s = PersistenceManager.openSession();
            if (log.isDebugEnabled())
            {
                log.debug(&quot;Opened hibernate session.&quot;);
            }

            session.set(s);
        }

        return s;
    }

    public static void closeSession() throws HibernateException, JDBCException
    {
        Session s = (Session) session.get();
        session.set(null);

        if (s != null)
        {
            if (s.isOpen())
            {
                s.flush();
                s.close();

                if (log.isDebugEnabled())
                {
                    log.debug(&quot;Closed hibernate session.&quot;);
                }
            }
        }
        else
        {
            log.warn(&quot;Hibernate session was inadvertently already closed.&quot;);

        }
    }
}

      </pre></div>
    </section>

    <section>
<h2><a name="Create_Servlet_Filter."></a>Create Servlet Filter.</h2>
      
<p>
        The servlet Filter is required if you use lazy loading of objects because you need to open a Hibernate sesion, and keeps it open through the view layer.
        This ensures that each user get's their own Hibernate Session.  ?? Should this be done
        through some sort of SessionValidator?

      </p>

        
<div class="source"><pre class="prettyprint">

package com.upstate.cellculture.filter;

import java.io.IOException;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import net.sf.hibernate.Session;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.upstate.cellculture.om.persist.PersistenceException;
import com.upstate.cellculture.om.persist.ServiceLocator;

public class ActionFilter implements Filter
{
    //~ Static fields/initializers =============================================

    //~ Instance fields ========================================================

    /**
     * The &lt;code&gt;Log&lt;/code&gt; instance for this class
     */
    private Log log = LogFactory.getLog(ActionFilter.class);
    private FilterConfig filterConfig = null;

    //~ Methods ================================================================

    public void init(FilterConfig filterConfig) throws ServletException
    {
        this.filterConfig = filterConfig;

    }

    /**
     * Destroys the filter.
     */
    public void destroy()
    {
        filterConfig = null;
    }

    public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws IOException, ServletException
    {
        // cast to the types I want to use
        HttpServletRequest request = (HttpServletRequest) req;
        HttpServletResponse response = (HttpServletResponse) resp;
        HttpSession session = request.getSession(true);

        Session ses = null;
        boolean sessionCreated = false;

        try
        {
            chain.doFilter(request, response);
        }
        finally
        {
            try
            {
                ServiceLocator.closeSession();
            }
            catch (Exception exc)
            {
                log.error(&quot;Error closing hibernate session.&quot;, exc);
                exc.printStackTrace();
            }
        }
    }

    public static Session getSession() throws PersistenceException
    {
        try
        {

            return ServiceLocator.currentSession();
        }
        catch (Exception e)
        {
            throw new PersistenceException(&quot;Could not find current Hibernate session.&quot;, e);
        }

    }
}


      </pre></div>
    </section>






    <section>
<h2><a name="Implementing_Manager_classes"></a>Implementing Manager classes</h2>
        
<p>
      To centralize access to the database, we create Manager classes.  Often Manager
      classes are called DAO (Data Access Classes).  Here is an example:
        </p>
        
<div class="source"><pre class="prettyprint">

/*
 * Created on Apr 28, 2003
 *
 */
package com.upstate.cellculture.om.persist;
import java.util.List;

import net.sf.hibernate.Query;
import net.sf.hibernate.Session;

import com.upstate.cellculture.om.Technician;
/**
 * @author tmckinney
 *
 * Centralizes all access to the Technicians table
 */
public class TechnicianManager
{
    private static List allTechnicians;
    public static void save(Technician technician) throws PersistenceException
    {
        try
        {

            ServiceLocator.currentSession().save(technician);

        }
        catch (Exception e)
        {
            throw new PersistenceException(&quot;Could not save.&quot;, e);
        }
    }

    public static Technician retrieveByPK(long technicianId) throws PersistenceException
       {
           try
             {
                 Technician technician= (Technician) ServiceLocator.currentSession().load(Technician.class, new Long(technicianId));
                 return technician;
             }
             catch (Exception e)
             {
                 throw new PersistenceException(&quot;Could not retrieve.&quot;, e);
             }
       }


    public static List retrieveAllTechnicians() throws PersistenceException
    {
        if (allTechnicians == null)
        {
            try
            {
                Query q = ServiceLocator.currentSession().createQuery(&quot;from technician in class &quot; + Technician.class +&quot; order by upper(technician.name)&quot;);
                allTechnicians = q.list();
                session.flush();
            }
            catch (Exception e)
            {
                e.printStackTrace();
                throw new PersistenceException(e);
            }
        }
        return allTechnicians;

    }


}


      </pre></div>
      
<p>
          By using this TechnicianManager class, we could feasibly swap out the Hibernate code
          for another OM strategy.  Even better would be to have a TechnicianManager interface
          and a TechicianManagerImpl class.  Possibly loaded via Avalon as a component!
      </p>
    </section>

    <section>
<h2><a name="Setup_PersitenceException_handling"></a>Setup PersitenceException handling</h2>
        
<p>
      By catching a generice Persistence Exception that wraps all the
      thrown exceptions we can just catch a single exception and then
      retrieve what type of exception it is.
        </p>
        
<div class="source"><pre class="prettyprint">

package com.upstate.cellculture.om.persist;

import org.apache.commons.lang.exception.NestableException;
/**
 * A general PersistenceException that is thrown by all Manager classes.
 *
 */
public class PersistenceException extends NestableException
{
    //~ Constructors ===========================================================

    /**
     * Constructor for PersistenceException.
     */
    public PersistenceException()
    {
        super();
    }

    /**
     * Constructor for PersistenceException.
     *
     * @param message
     */
    public PersistenceException(String message)
    {
        super(message);
    }

    /**
     * Constructor for PersistenceException.
     *
     * @param message
     * @param cause
     */
    public PersistenceException(String message, Throwable cause)
    {
        super(message, cause);
    }

    /**
     * Constructor for PersistenceException.
     *
     * @param cause
     */
    public PersistenceException(Throwable cause)
    {
        super(cause);
    }

}


      </pre></div>

    </section>
  

        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>&#169;      2000&#x2013;2024
<a href="https://www.apache.org/">The Apache Software Foundation</a>
</p>
        </div>
      </div>
    </footer>
  </body>
</html>
