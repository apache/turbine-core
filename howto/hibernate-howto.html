<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><title>Turbine - Hibernate Howto</title><style type="text/css" media="all">
          @import url("../style/maven-base.css");
          
          @import url("../style/maven-theme.css");</style><link rel="stylesheet" href="../style/print.css" type="text/css" media="print"></link><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"></meta><meta name="author" content="Eric Pugh"></meta><meta name="email" content="epugh@upstate.com"></meta></head><body class="composite"><div id="banner"><a href="http://turbine.apache.org/" id="organizationLogo"><img alt="Apache Software Foundation" src="../images/turbine-project.png"></img></a><a href="http://turbine.apache.org/turbine/turbine-2.3.3/index.html" id="projectLogo"><img alt="turbine-2" src="../images/logo.gif"></img></a><div class="clear"><hr></hr></div></div><div id="breadcrumbs"><div class="xleft">Last published: 21 November 2008
                <span class="separator">|</span> Doc for  2.3.3
                </div><div class="xright">
        
        <a href="http://turbine.apache.org/">Turbine Home</a>
      
        
          
            <span class="separator">|</span>
          
        
        <a href="http://turbine.apache.org/fulcrum/">Fulcrum</a>
      
        
          
            <span class="separator">|</span>
          
        
        <a href="http://turbine.apache.org/meta/">META</a>
      </div><div class="clear"><hr></hr></div></div><div id="leftColumn"><div id="navcolumn"><div id="menuGeneral_Information"><h5>General Information</h5><ul><li class="none"><a href="../index.html">Overview</a></li><li class="none"><a href="../features.html">Features</a></li><li class="none"><a href="../fsd.html">Specification</a></li><li class="none"><a href="../getting-started.html">Getting Started</a></li></ul></div><div id="menuDocumentation"><h5>Documentation</h5><ul><li class="none"><a href="../changes-report.html">Changes</a></li><li class="none"><a href="../turbine-schema.html">Core DB Schema</a></li><li class="collapsed"><a href="../services/index.html">Services</a></li><li class="expanded"><a href="../howto/index.html">Howtos</a><ul><li class="none"><a href="../howto/action-event-howto.html">Action Events Howto</a></li><li class="none"><a href="../howto/configuration-howto.html">Configuration Howto</a></li><li class="none"><a href="../howto/extend-user-howto.html">Extend User Howto</a></li><li class="none"><strong><a href="../howto/hibernate-howto.html">Hibernate OM Howto</a></strong></li><li class="none"><a href="../howto/intake-howto.html">Intake Howto</a></li><li class="none"><a href="../howto/jboss-howto.html">JBoss Howto</a></li><li class="none"><a href="../howto/jsp-howto.html">JSP Howto</a></li><li class="none"><a href="../howto/migrate-from-2_1-howto.html">Migrating 2.1 to 2.2</a></li><li class="none"><a href="../howto/migrate-from-2_2-howto.html">Migrating 2.2 to 2.3</a></li><li class="none"><a href="../howto/pullmodel-howto.html">Pull Model Howto</a></li><li class="none"><a href="../howto/python-howto.html">Python Howto</a></li><li class="none"><a href="../howto/security-howto.html">Security Howto</a></li><li class="none"><a href="../howto/services-howto.html">Services Howto</a></li><li class="none"><a href="../howto/sql-howto.html">How to build the SQL files</a></li><li class="none"><a href="../howto/url-rewriting-howto.html">URL rewriting Howto</a></li><li class="none"><a href="../howto/context-howto.html">Velocity Context Howto</a></li><li class="none"><a href="../howto/velocity-site-howto.html">Velocity Site Howto</a></li><li class="none"><a href="../howto/velocityonlylayout-howto.html">VelocityOnlyLayout Howto</a></li><li class="none"><a href="http://wiki.apache.org/turbine/Turbine2" class="externalLink" title="External Link">Wiki Howtos</a></li></ul></li><li class="none"><a href="../apidocs/index.html">JavaDocs</a></li></ul></div><div id="menuDevelopment"><h5>Development</h5><ul><li class="none"><a href="../proposals.html">Proposals</a></li><li class="none"><a href="../how-to-help.html">How To Help</a></li><li class="none"><a href="../todo.html">Todo</a></li></ul></div><div id="menuProject_Documentation"><h5>Project Documentation</h5><ul><li class="none"><a href="../index.html">About</a></li><li class="collapsed"><a href="../project-info.html">Project Info</a></li><li class="collapsed"><a href="../maven-reports.html">Project Reports</a></li><li class="none"><a href="../development-process.html">Development Process</a></li></ul></div><div id="legend"><h5>Legend</h5><ul><li class="externalLink">External Link</li><li class="newWindow">Opens in a new window</li></ul></div><a href="http://maven.apache.org/" title="Built by Maven" id="poweredBy"><img alt="Built by Maven" src="../images/logos/mavenlogo_builtby_w.png"></img></a></div></div><div id="bodyColumn"><div class="contentBox"><div class="section"><a name="Introduction"></a><h2>Introduction</h2>
      <p>
        This is a HOWTO on implementing Hibernate as the database OM layer.  The motivating factors for using Hibernate
        are:
        <ol>
          <li>
      You just use POJO (Plain Old Java Objects) versus generated objects.
          </li>
          <li>
      You can either start with Java objects and create your database schema from there, or
      start with a database schema, and map the Java objects to the schema.
          </li>
          <li>
      Extensive performance optimizations built into the Hibernate engine.
          </li>
          <li>
      Leverage Avalon component use in Turbine 2.3!
          </li>
        </ol>
      </p>
      <p>
        Please review the content available from the Hibernate homepage.  This howto assumes
        you already are comfortable with the various Hibernate concepts.
      </p>
      <p>
    In this example, we will take a simple schema with a single table and integrate Hibernate into
    a Turbine action.  We will talk about best practices for Hibernate and Turbine.
        <ol>
          <li>
        Configure project dependencies.
          </li>
          <li>
        Directory Structures
          </li>

          <li>
        Setup Avalon component configuration.
          </li>

          <li>
          Setup Hibernate mapping files.
          </li>
          <li>
          Create static ServiceLocator class.
          </li>
          <li>
            Create filter that manages the Hibernate Session.
          </li>
          <li>
            Setup PersitenceException handling
          </li>
        </ol>
      </p>

    </div><div class="section"><a name="Directory_Structures"></a><h2>Directory Structures</h2>
      <p>
      While you can organize your directory structure however you like, I tend to have structure like:
      </p>
      
    <div class="source"><pre>
      /src/java/com/my/project/bizobj business objects reside
      /src/java/com/my/project/om POJO objects mapped to database reside
      /src/java/com/my/project/om/persist manager objects that facilitate retrieve POJO objects
      /src/java/com/my/project/om/filter Servlet Filter lives that maintains the Hibernate Session
      /src/java/ where hibernate.hbm.xml and hibernate.cfg.xml files live

    </pre></div>
  

    </div><div class="section"><a name="Configure_project_dependencies"></a><h2>Configure project dependencies</h2>
      <p>
        The easiest way to maintain a project is to use Maven.  Here are the sample
        dependencies for your project.xml.
      </p>
      
    <div class="source"><pre>

    &lt;dependency&gt;
      &lt;id&gt;hibernate&lt;/id&gt;
      &lt;version&gt;2.0-beta6&lt;/version&gt;
      &lt;properties&gt;
      &lt;war.bundle.jar&gt;true&lt;/war.bundle.jar&gt;
      &lt;/properties&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;id&gt;hibernate:hibernate-avalon&lt;/id&gt;
      &lt;version&gt;0.1&lt;/version&gt;
      &lt;properties&gt;
      &lt;war.bundle.jar&gt;true&lt;/war.bundle.jar&gt;
      &lt;/properties&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;id&gt;dom4j&lt;/id&gt;
      &lt;version&gt;1.4&lt;/version&gt;
      &lt;properties&gt;
      &lt;war.bundle.jar&gt;true&lt;/war.bundle.jar&gt;
      &lt;/properties&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;id&gt;cglib&lt;/id&gt;
      &lt;version&gt;rc2-1.0&lt;/version&gt;
      &lt;properties&gt;
      &lt;war.bundle.jar&gt;true&lt;/war.bundle.jar&gt;
      &lt;/properties&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;id&gt;jcs&lt;/id&gt;
      &lt;version&gt;1.0-dev&lt;/version&gt;
      &lt;properties&gt;
      &lt;war.bundle.jar&gt;true&lt;/war.bundle.jar&gt;
      &lt;/properties&gt;
    &lt;/dependency&gt;

      </pre></div>
  
      <p>
        The key jar file is the hibernate-avalon.jar file, it contains the Avalon wrapper
        for Hibernate, and can be used with any Avalon container.
      </p>

    </div><div class="section"><a name="Setting_up_Avalon_Configuration"></a><h2>Setting up Avalon Configuration</h2>

        <p>
      We leverage the Avalon based HibernateService that is hosted as part of the
      HibernateExt project.  You must specify the name of the service, as well as the implementing
      service in your componentConfiguration.xml file.  Other configuration parameters can be passed
      in as well.
        </p>
      
    <div class="source"><pre>


&lt;my-system&gt;
  &lt;component
    role="net.sf.hibernate.avalon.HibernateService"
    class="net.sf.hibernate.avalon.HibernateServiceImpl"&gt;
  &lt;/component&gt;
&lt;/my-system&gt;


      </pre></div>
  

        <p>
      The componentRoles file also defines how to access the component.  Here is a
      very simple componentRoles.xml file:
        </p>
      
    <div class="source"><pre>


&lt;role-list&gt;
 &lt;role
    name="net.sf.hibernate.avalon.HibernateService"
    shorthand="hibernate"
    default-class="net.sf.hibernate.avalon.HibernateServiceImpl"/&gt;
&lt;/role-list&gt;


      </pre></div>
  
    </div><div class="section"><a name="Setup_Hibernate_mapping_files"></a><h2>Setup Hibernate mapping files</h2>
      <p>
    This section will not go into depth on how to configure the hibernate.cfg.xml and
    hibernate.hbm.xml files.  However, if you don't specify in the componentConfiguration.xml
    file where they are located, then they should be placed in your src/java/ directory.
      </p>
      <p>
        The exact configuration is dependent on the environment Turbine is running in, however
        I highly recommend that you use the JNDI look up of the datasource, and use DBCP for your
        connection pooling.  I have found that when using Hibernate in cactus tests, you may need to
        increase the pool size required in order to not run out of connections, however this doesn't
        seem to apply to running as a web application.
      </p>
    </div><div class="section"><a name="Create_static_ServiceLocator_class_"></a><h2>Create static ServiceLocator class.</h2>
      <p>
    Currently this class is not integrated into Turbine, so you will need to provide an implementation yourself.
    This provides a static method of retrieving your Hibernate Session.
      </p>

        
    <div class="source"><pre>

package com.upstate.cellculture.om.persist;

import net.sf.hibernate.HibernateException;
import net.sf.hibernate.JDBCException;
import net.sf.hibernate.Session;
import net.sf.hibernate.SessionFactory;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

/**
 * This class is used to get Hibernate Sessions and may
 * also contain methods (in the future) to get DBConnections
 * or Transactions from JNDI.
 */
public class ServiceLocator
{
    //~ Static fields/initializers =============================================
    public final static String SESSION_FACTORY = "hibernate/sessionFactory";
    public static final ThreadLocal session = new ThreadLocal();
    private static SessionFactory sf = null;
    private static ServiceLocator me;
    private static Log log = LogFactory.getLog(ServiceLocator.class);

    static {
        try
        {
            me = new ServiceLocator();
        }
        catch (Exception e)
        {
            log.fatal("Error occurred initializing ServiceLocator");
            e.printStackTrace();
        }
    }

    //~ Constructors ===========================================================

    private ServiceLocator() throws HibernateException, JDBCException
    {}

    //~ Methods ================================================================

    public static Session currentSession() throws PersistenceException
    {
        Session s = (Session) session.get();

        if (s == null)
        {
            s = PersistenceManager.openSession();
            if (log.isDebugEnabled())
            {
                log.debug("Opened hibernate session.");
            }

            session.set(s);
        }

        return s;
    }

    public static void closeSession() throws HibernateException, JDBCException
    {
        Session s = (Session) session.get();
        session.set(null);

        if (s != null)
        {
            if (s.isOpen())
            {
                s.flush();
                s.close();

                if (log.isDebugEnabled())
                {
                    log.debug("Closed hibernate session.");
                }
            }
        }
        else
        {
            log.warn("Hibernate session was inadvertently already closed.");

        }
    }
}

      </pre></div>
  
    </div><div class="section"><a name="Create_Servlet_Filter_"></a><h2>Create Servlet Filter.</h2>
      <p>
        The servlet Filter is required if you use lazy loading of objects because
        you need to open a Hibernate session, and keeps it open through the view layer.
        This ensures that each user get's their own Hibernate Session.  ?? Should this be done
        through some sort of SessionValidator?

      </p>

        
    <div class="source"><pre>

package com.upstate.cellculture.filter;

import java.io.IOException;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import net.sf.hibernate.Session;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import com.upstate.cellculture.om.persist.PersistenceException;
import com.upstate.cellculture.om.persist.ServiceLocator;

public class ActionFilter implements Filter
{
    //~ Static fields/initializers =============================================

    //~ Instance fields ========================================================

    /**
     * The &lt;code&gt;Log&lt;/code&gt; instance for this class
     */
    private Log log = LogFactory.getLog(ActionFilter.class);
    private FilterConfig filterConfig = null;

    //~ Methods ================================================================

    public void init(FilterConfig filterConfig) throws ServletException
    {
        this.filterConfig = filterConfig;

    }

    /**
     * Destroys the filter.
     */
    public void destroy()
    {
        filterConfig = null;
    }

    public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws IOException, ServletException
    {
        // cast to the types I want to use
        HttpServletRequest request = (HttpServletRequest) req;
        HttpServletResponse response = (HttpServletResponse) resp;
        HttpSession session = request.getSession(true);

        Session ses = null;
        boolean sessionCreated = false;

        try
        {
            chain.doFilter(request, response);
        }
        finally
        {
            try
            {
                ServiceLocator.closeSession();
            }
            catch (Exception exc)
            {
                log.error("Error closing hibernate session.", exc);
                exc.printStackTrace();
            }
        }
    }

    public static Session getSession() throws PersistenceException
    {
        try
        {

            return ServiceLocator.currentSession();
        }
        catch (Exception e)
        {
            throw new PersistenceException("Could not find current Hibernate session.", e);
        }

    }
}


      </pre></div>
  
    </div><div class="section"><a name="Implementing_Manager_classes"></a><h2>Implementing Manager classes</h2>
        <p>
      To centralize access to the database, we create Manager classes.  Often Manager
      classes are called DAO (Data Access Classes).  Here is an example:
        </p>
        
    <div class="source"><pre>

/*
 * Created on Apr 28, 2003
 *
 */
package com.upstate.cellculture.om.persist;
import java.util.List;

import net.sf.hibernate.Query;
import net.sf.hibernate.Session;

import com.upstate.cellculture.om.Technician;
/**
 * @author tmckinney
 *
 * Centralizes all access to the Technicians table
 */
public class TechnicianManager
{
    private static List allTechnicians;
    public static void save(Technician technician) throws PersistenceException
    {
        try
        {

            ServiceLocator.currentSession().save(technician);

        }
        catch (Exception e)
        {
            throw new PersistenceException("Could not save.", e);
        }
    }

    public static Technician retrieveByPK(long technicianId) throws PersistenceException
       {
           try
             {
                 Technician technician= (Technician) ServiceLocator.currentSession().load(Technician.class, new Long(technicianId));
                 return technician;
             }
             catch (Exception e)
             {
                 throw new PersistenceException("Could not retrieve.", e);
             }
       }


    public static List retrieveAllTechnicians() throws PersistenceException
    {
        if (allTechnicians == null)
        {
            try
            {
                Query q = ServiceLocator.currentSession().createQuery("from technician in class " + Technician.class +" order by upper(technician.name)");
                allTechnicians = q.list();
                session.flush();
            }
            catch (Exception e)
            {
                e.printStackTrace();
                throw new PersistenceException(e);
            }
        }
        return allTechnicians;

    }


}


      </pre></div>
  
      <p>
          By using this TechnicianManager class, we could feasibly swap out the Hibernate code
          for another OM strategy.  Even better would be to have a TechnicianManager interface
          and a TechicianManagerImpl class.  Possibly loaded via Avalon as a component!
      </p>
    </div><div class="section"><a name="Setup_PersitenceException_handling"></a><h2>Setup PersitenceException handling</h2>
        <p>
      By catching a generice Persistence Exception that wraps all the
      thrown exceptions we can just catch a single exception and then
      retrieve what type of exception it is.
        </p>
        
    <div class="source"><pre>

package com.upstate.cellculture.om.persist;

import org.apache.commons.lang.exception.NestableException;
/**
 * A general PersistenceException that is thrown by all Manager classes.
 *
 */
public class PersistenceException extends NestableException
{
    //~ Constructors ===========================================================

    /**
     * Constructor for PersistenceException.
     */
    public PersistenceException()
    {
        super();
    }

    /**
     * Constructor for PersistenceException.
     *
     * @param message
     */
    public PersistenceException(String message)
    {
        super(message);
    }

    /**
     * Constructor for PersistenceException.
     *
     * @param message
     * @param cause
     */
    public PersistenceException(String message, Throwable cause)
    {
        super(message, cause);
    }

    /**
     * Constructor for PersistenceException.
     *
     * @param cause
     */
    public PersistenceException(Throwable cause)
    {
        super(cause);
    }

}


      </pre></div>
  

    </div></div></div><div class="clear"><hr></hr></div><div id="footer"><div class="xright">© 2000-2008, Apache Software Foundation</div><div class="clear"><hr></hr></div></div></body></html>