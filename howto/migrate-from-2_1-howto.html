<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head><title>Turbine - Migrating from 2.1 to 2.2</title><style type="text/css" media="all">
          @import url("../style/maven-base.css");
          
          @import url("../style/maven-theme.css");</style><link rel="stylesheet" href="../style/print.css" type="text/css" media="print"></link><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"></meta><meta name="author" content="Quinton McCombs"></meta><meta name="email" content="quintonm@bellsouth.net"></meta><meta name="author" content="Scott Eade"></meta><meta name="email" content="seade@backstagetech.com.au"></meta></head><body class="composite"><div id="banner"><a href="http://turbine.apache.org/" id="organizationLogo"><img alt="Apache Software Foundation" src="../images/turbine-project.png"></img></a><a href="http://turbine.apache.org/turbine/turbine-2.3.3/index.html" id="projectLogo"><img alt="turbine-2" src="../images/logo.gif"></img></a><div class="clear"><hr></hr></div></div><div id="breadcrumbs"><div class="xleft">Last published: 21 November 2008
                <span class="separator">|</span> Doc for  2.3.3
                </div><div class="xright">
        
        <a href="http://turbine.apache.org/">Turbine Home</a>
      
        
          
            <span class="separator">|</span>
          
        
        <a href="http://turbine.apache.org/fulcrum/">Fulcrum</a>
      
        
          
            <span class="separator">|</span>
          
        
        <a href="http://turbine.apache.org/meta/">META</a>
      </div><div class="clear"><hr></hr></div></div><div id="leftColumn"><div id="navcolumn"><div id="menuGeneral_Information"><h5>General Information</h5><ul><li class="none"><a href="../index.html">Overview</a></li><li class="none"><a href="../features.html">Features</a></li><li class="none"><a href="../fsd.html">Specification</a></li><li class="none"><a href="../getting-started.html">Getting Started</a></li></ul></div><div id="menuDocumentation"><h5>Documentation</h5><ul><li class="none"><a href="../changes-report.html">Changes</a></li><li class="none"><a href="../turbine-schema.html">Core DB Schema</a></li><li class="collapsed"><a href="../services/index.html">Services</a></li><li class="expanded"><a href="../howto/index.html">Howtos</a><ul><li class="none"><a href="../howto/action-event-howto.html">Action Events Howto</a></li><li class="none"><a href="../howto/configuration-howto.html">Configuration Howto</a></li><li class="none"><a href="../howto/extend-user-howto.html">Extend User Howto</a></li><li class="none"><a href="../howto/hibernate-howto.html">Hibernate OM Howto</a></li><li class="none"><a href="../howto/intake-howto.html">Intake Howto</a></li><li class="none"><a href="../howto/jboss-howto.html">JBoss Howto</a></li><li class="none"><a href="../howto/jsp-howto.html">JSP Howto</a></li><li class="none"><strong><a href="../howto/migrate-from-2_1-howto.html">Migrating 2.1 to 2.2</a></strong></li><li class="none"><a href="../howto/migrate-from-2_2-howto.html">Migrating 2.2 to 2.3</a></li><li class="none"><a href="../howto/pullmodel-howto.html">Pull Model Howto</a></li><li class="none"><a href="../howto/python-howto.html">Python Howto</a></li><li class="none"><a href="../howto/security-howto.html">Security Howto</a></li><li class="none"><a href="../howto/services-howto.html">Services Howto</a></li><li class="none"><a href="../howto/sql-howto.html">How to build the SQL files</a></li><li class="none"><a href="../howto/url-rewriting-howto.html">URL rewriting Howto</a></li><li class="none"><a href="../howto/context-howto.html">Velocity Context Howto</a></li><li class="none"><a href="../howto/velocity-site-howto.html">Velocity Site Howto</a></li><li class="none"><a href="../howto/velocityonlylayout-howto.html">VelocityOnlyLayout Howto</a></li><li class="none"><a href="http://wiki.apache.org/turbine/Turbine2" class="externalLink" title="External Link">Wiki Howtos</a></li></ul></li><li class="none"><a href="../apidocs/index.html">JavaDocs</a></li></ul></div><div id="menuDevelopment"><h5>Development</h5><ul><li class="none"><a href="../proposals.html">Proposals</a></li><li class="none"><a href="../how-to-help.html">How To Help</a></li><li class="none"><a href="../todo.html">Todo</a></li></ul></div><div id="menuProject_Documentation"><h5>Project Documentation</h5><ul><li class="none"><a href="../index.html">About</a></li><li class="collapsed"><a href="../project-info.html">Project Info</a></li><li class="collapsed"><a href="../maven-reports.html">Project Reports</a></li><li class="none"><a href="../development-process.html">Development Process</a></li></ul></div><div id="legend"><h5>Legend</h5><ul><li class="externalLink">External Link</li><li class="newWindow">Opens in a new window</li></ul></div><a href="http://maven.apache.org/" title="Built by Maven" id="poweredBy"><img alt="Built by Maven" src="../images/logos/mavenlogo_builtby_w.png"></img></a></div></div><div id="bodyColumn"><div class="contentBox"><div class="section"><a name="Important_note"></a><h2>Important note</h2>
<p>
    The information in this HOWTO pertains to Turbine 2.2.  Please refer
    to the <a href="migrate-from-2_2-howto.html">Migrating from
    2.2 to 2.3</a> page for information on migrating to Turbine 2.3.
</p>
</div><div class="section"><a name="Introduction"></a><h2>Introduction</h2>
<p>
    This document describes the basic steps needed to migrate an
    application written for Turbine 2.1 to Turbine 2.2 using the
    decoupled Torque.
</p>
<p>
    You may find that migrating to 2.2 is not all that difficult.
    Of course, this depends quite a bit on how much of Turbine your
    application actually uses.  You may find migrating to 2.2 to be
    quite a chore, but it is well worth the effort. Most of the
    pain in figuring out this migration process has been documented
    in the mailing list archives, but is summarized here for your
    convenience.
</p>
</div><div class="section"><a name="Cleanup"></a><h2>Cleanup</h2>
<p>
    Start off with deleting all of the objects that Torque generated
    for you. I am talking about om.map.* and om.Base*. You will be
    able to regenerate them later during the migration process.
</p>
</div><div class="section"><a name="Build_and_Properties_Files"></a><h2>Build and Properties Files</h2>
<p>
    The structure of the build files used by Turbine has changed
    quite a bit with the 2.2 release. The easiest way of obtaining
    a reference set of property (and build files) is to install
    version 2.2 of the TDK and generate the demo application.
</p>
<p>
    From the demo application you should:
    <ul>
    <li>Merge <code>tdk-2.2/webapps/newapp/WEB-INF/conf/build.properties</code>
        with your existing properties file.</li>
    <li>Copy <code>build-torque.xml</code> from the demo application
        to your build directory.</li>
    <li>Copy <code>project-build.xml</code> from the demo application
        to your build directory.</li>
    <li>Merge <code>build.xml</code> from the demo application
        to your existing build file (if you have only ever used the
        default build file supplied with the tdk then I assume you
        can just replace your file with the new one).</li>
    <li>Copy <code>WEB-INF/conf/TurbineResources.template</code> and
        <code>WEB-INF/conf/Torque.template</code>) to your application
        and apply changes as needed (it is up to you as to how much you
        hard code into your application template and how much you allow
        to be processed into the resulting properties files by way of
        <code>build.properties</code> or the other property files).</li>
    </ul>
</p>
<p>
    See the Torque
  <a href="http://db.apache.org/torque/releases/torque-3.1/generator/properties-reference.html" class="externalLink" title="External Link">
    Properties Reference</a> for full details of the available properties (link
    is to 3.1, rather than the 3.0 release of torque).
</p>
</div><div class="section"><a name="Libraries"></a><h2>Libraries</h2>
<p>
    Turbine and Torque use updated versions of a number of
    libraries (jar files). Take a look at the WEB-INF/lib directory
    of the TDK sample application to see which libraries have been
    updated and replace the files in the lib directory of your
    application as needed.
</p>
<p>
    Note that if you have applied local changes to Turbine itself
    then you should ensure that your changes have made it into the
    Turbine 2.2 and Torque 3.0 releases.  If any of your changes
    have not made it then you will need to port these changes forward
    and build your own versions of the Turbine and Torque jar files
    (while you are there you may as well create patches and submit
    them to the relevant modules in Scarab so that they can be
    included in future releases).
</p>
<p>
    By default Torque will utilize a set of  Velocity templates that
    you need to extract from the Torque jar file (see the
    <code>torque.templatePath</code> property). Unless you have a
    need to alter these templates you may prefer to use these directly
    from the jar file.  To do this you need to set the
    <code>torque.useClasspath</code> property to <code>true</code> in
    <code>build.properties</code>.  In any case, you should either
    replace or delete the old versions of these templates from your
    existing project.
</p>
</div><div class="section"><a name="Import_Statements"></a><h2>Import Statements</h2>
<p>
    Many of your import statements will need to be changed. This is
    due to the decoupled version of Torque. This will take care of
    most of the changes due to refactoring. There will still be a
    few cases (discussed later) where the methods have been changed and/or
    moved to different classes.
</p>
<p>
    <a href="http://db.apache.org/torque/changes-report.html#3_0-B3" class="externalLink" title="External Link">
    [Here]</a> is list of the most common import changes.
</p>
</div><div class="section"><a name="Transactions_and_obtaining_database_connections"></a><h2>Transactions and obtaining database connections</h2>
<p>
    org.apache.turbine.util.db.DBConnection is gone. The replacement
    is java.sql.Connection. This was a wrapper class from the
    Connection object. It was returned when you asked for a database
    connection. The new version of Torque will simply return a
    Connection object.
</p>
<p>
    org.apache.turbine.services.db.TurbineDB is gone. The replacement
    is org.apache.torque.Torque. This was mainly used to obtain
    database connections and the name of the default database. All
    of this functionality is in the new class.
</p>
<p>
    Below is an example of how you might have been obtaining database
    connections in version 2.1.
</p>


    <div class="source"><pre>

DBConnection dbConn = null;
try
{
    dbConn = TurbineDB.getConnection();
    // Do something with the connection here...
}
catch (Exception e)
{
    // Either from obtaining the connection or from your application code.
}
finally
{
    try
    {
        TurbineDB.releaseConnection(dbConn);
    }
    catch (Exception e)
    {
        // Error releasing database connection back to pool.
    }
}

</pre></div>
  
<p>
    Using the new version of Torque this would be rewritten as follows.
</p>

    <div class="source"><pre>

Connection conn = null;
try
{
    conn = Torque.getConnection();
    // Do something with the connection here...
}
catch (TorqueException ex)
{
    // Either from obtaining the connection or from your application code.
	Log.error(ex);
}
finally
{
    Torque.closeConnection(conn);
}

</pre></div>
  
<p>
    Support for transactions has been moved from org.apache.turbine.om.BasePeer
    into org.apache.torque.util.Transaction. The method names have changed
    slightly as well. Here is an example of using transactions in 2.1.
</p>

    <div class="source"><pre>

DBConnection dbConn = null;
try
{
    dbConn = BasePeer.beginTrasaction(TurbineDB.getDefaultDB?());
    someObject.save(dbConn);
    someOtherObject.save(dbConn);
    BasePeer.commitTransaction(dbConn);
}
catch (Exception e)
{
    // Either from obtaining the connection or from your application code.
    BasePeer?.rollbackTransaction(dbConn);
}

</pre></div>
  
<p>
    This would now be written as shown below.
</p>

    <div class="source"><pre>

Connection conn = null;
try
{
    conn = Transaction.begin(Torque.getDefaultDB());
    someObject.save(conn);
    someOtherObject.save(conn);
    Transaction.commit(conn);
}
catch (TorqueException ex)
{
    try
    {
        Transaction.rollback(conn);
    }
    catch (TorqueException ex2)
    {
        Log.error(ex2);
    }
    Log.error(ex);
}

</pre></div>
  
</div><div class="section"><a name="Vector_becomes_List"></a><h2>Vector becomes List</h2>
<p>
    Methods generated by Torque that previously had a return type of
    <code>Vector</code> now have a return type of <code>List</code>.
    If you have not already been doing so you should switch to
    retrieving the results of these methods into variables declared
    as <code>List</code>.  While you are at it you might like to
    update any of your own code to use <code>ArrayList</code> in
    preference to <code>Vector</code>.
</p>
</div><div class="section"><a name="Exception_becomes_TorqueException"></a><h2>Exception becomes TorqueException</h2>
<p>
    Methods generated by Torque now throw <code>TorqueException</code>
    rather than <code>Exception</code>.  You might like to update
    your code to match.
</p>
<p>
    Note that the exception thrown by <code>save()</code> methods is
    determined by the Torque property <code>torque.saveException</code>
    which defaults to <code>Exception</code>.
</p>
</div><div class="section"><a name="Extending_Turbine_User"></a><h2>Extending Turbine User</h2>
<p>
    See
    <a href="extend-user-howto.html">
    Extending Turbine User How-To</a> for this information.
</p>
</div><div class="section"><a name="Changes_to_the_OM_classes"></a><h2>Changes to the OM classes</h2>
<p>
    Read over the Torque Schema Reference to find out what to change
    in your project-schema.xml file. The main changes are the
    deprecation of sequence and autoIncrement idMethods and the
    addition of the javaType attribute to column elements
    (Torque can now work with object types).
</p>
<p>
    If you used inheritance, you will run need to specify
    abstract="true" for the tables which have abstract base
    classes. When you do this, you will need to implement the
    copy() method in your subclasses. An example is provided below.
</p>

    <div class="source"><pre>

public &lt;base class&gt; copy() throws TorqueException
{
    return copyInto(new &lt;sub class&gt;());
}

</pre></div>
  
<p>
    Atributes defined as primary keys are no longer generated
    as NumberKey objects. They are now Integer or int (depending
    on the javaType specified in project-schema.xml).
</p>
<p>
    If you have a turbine-schema.xml file in your WEB-INF/conf
    directory, the project-om ant task will generate all of the
    Turbine*, BaseTurbine*, and map.Turbine* objects for you.
    These will not be used by Turbine. They will only confuse
    you. The best thing to do for this is to rename your
    turbine-schema.xml file to something like turbine-schema.nogenerate.
</p>
</div><div class="section"><a name="XML-RPC_service"></a><h2>XML-RPC service</h2>
<p>
    My TurbineResources.properties did not have settings to
    configure the secure options. This caused initialization
    of the service to fail. To fix this, I simply obtained all
    of the configuration settings from the TurbineResources.properties
    included with the source version.
</p>
<p>
    The service does not listen on the loopback interface by default
    any longer. There were no other changes that are required to get
    this service up and running under T2.2.
</p>
</div><div class="section"><a name="Other_services"></a><h2>Other services</h2>
<p>
    Intake, Security, and Scheduler all work without a problem
    after migrating to T2.2.
</p>
</div><div class="section"><a name="Maven"></a><h2>Maven</h2>
<p>
    You may like to consider using
    <a href="http://maven.apache.org/" class="externalLink" title="External Link">Maven</a> to
    build your project.  The  document
    <a href="http://wiki.apache.org/turbine/TDK/Maven" class="externalLink" title="External Link">
    Starting your project and database with TDK2.2 and Maven</a>
    provides some information that can be adapted for this purpose
    (jump down to the "Moving The Sample" heading for the
    documentation relevant to an existing project).
</p>
<p>
    Better still, use <a href="http://turbine.apache.org/meta/">META</a>.
</p>
</div><div class="section"><a name="Updates_to_this_document"></a><h2>Updates to this document</h2>
<p>
    This document is by no means complete or totally accurate. We welcome
    suggestions as to how it might be improved, particularly if you have
    just completed migrating an application by following this howto.
</p>
</div></div></div><div class="clear"><hr></hr></div><div id="footer"><div class="xright">© 2000-2008, Apache Software Foundation</div><div class="clear"><hr></hr></div></div></body></html>